{"1765477064127":{"actionType":"saveAll","createdAt":"1765477064127","actionID":"1765477064127","userID":"#TEMP","path":"system.capsules.830af753-f3c2-4ba3-aedb-6e10b6d47170.capsUseCodeInfo.capsUseInputs.sss_custom_caps-0.capsIptTxtValue","oldValue":"async () => {\n  try {\n    const pathName = \"sc.A12.forms.iptsChanges.partnerName\";\n    const pathEmail = \"sc.A12.forms.iptsChanges.partnerMail\";\n    const pathPartner = \"sc.A12.forms.iptsChanges.partnerActivity\";\n\n    const name = (tools.getCtData(pathName) ?? \"\").trim();\n    const email = (tools.getCtData(pathEmail) ?? \"\").trim();\n    const partnerActivity = (tools.getCtData(pathPartner) ?? \"\").trim();\n    console.log({ name, email });\n\n    const validateEmail = (v: string) => v.includes(\"@\") && v.includes(\".\");\n    console.log({ validateEmail: validateEmail(email) });\n\n    if (name === \"\") {\n      tools.setData({ path: \"sc.A12.forms.showErr\", value: true });\n      tools.setData({ path: \"sc.A12.msgs.msg1\", value: \"Preencha o Nome.\" });\n      return;\n    }\n    if (email === \"\") {\n      tools.setData({ path: \"sc.A12.forms.showErr\", value: true });\n      tools.setData({ path: \"sc.A12.msgs.msg1\", value: \"Preencha o Email.\" });\n      return;\n    }\n\n    if (!validateEmail(email)) {\n      tools.setData({ path: \"sc.A12.forms.showErr\", value: true });\n      tools.setData({ path: \"sc.A12.msgs.msg1\", value: \"Email inválido.\" });\n      return;\n    }\n\n    // ---------------- função auxiliar: vincular condomínio em parceiro já existente\n    const vincularCondoEmUserExistente = async (emailToFind: string) => {\n      console.log(\"Vinculando condomínio a usuário já existente:\", emailToFind);\n\n      const {\n        getFirestore,\n        collection,\n        query,\n        where,\n        getDocs,\n        doc,\n        updateDoc,\n        arrayUnion,\n      } = await import(\"firebase/firestore\");\n\n      const fbInitAux = tools.getCtData(\"all.temp.fireInit\");\n      const dbAux = fbInitAux ? getFirestore(fbInitAux) : getFirestore();\n\n      const condoIdAux =\n        tools.getCtData(\"sc.A11.forms.iptsChanges.condoData.docId\") ?? \"\";\n\n      if (!condoIdAux) {\n        console.warn(\"Nenhum condoId selecionado para vincular.\");\n        tools.setData({ path: \"sc.A12.forms.showErr\", value: true });\n        tools.setData({\n          path: \"sc.A12.msgs.msg1\",\n          value: \"Nenhum condomínio selecionado para vincular.\",\n        });\n        return;\n      }\n\n      const q = query(\n        collection(dbAux, \"users\"),\n        where(\"userEmail\", \"==\", emailToFind)\n      );\n\n      const snap = await getDocs(q);\n\n      if (snap.empty) {\n        console.warn(\"Usuário existe no Auth, mas não está em 'users'.\");\n        tools.setData({ path: \"sc.A12.forms.showErr\", value: true });\n        tools.setData({\n          path: \"sc.A12.msgs.msg1\",\n          value:\n            \"Usuário existe no Auth, mas não foi encontrado na base de usuários.\",\n        });\n        return;\n      }\n\n      const userDoc = snap.docs[0];\n      const uid = userDoc.id;\n      const userRef = doc(dbAux, \"users\", uid);\n\n      await updateDoc(userRef, {\n        condoIds: arrayUnion(condoIdAux),\n      });\n\n      console.log(\"Condomínio vinculado ao user existente:\", {\n        uid,\n        condoIdAux,\n      });\n\n      // feedback de sucesso\n      tools.setData({ path: \"sc.A12.forms.showErr\", value: false });\n      tools.setData({ path: \"sc.A12.forms.showSuccess\", value: true });\n      tools.setData({\n        path: \"sc.A12.forms.msgs.msg1\",\n        value: \"Condomínio vinculado ao parceiro existente!\",\n      });\n\n      const delay = () => {\n        tools.setData({ path: \"all.toggles.sideRight\", value: false });\n        tools.functions.setVar({\n          args: \"\",\n          pass: {\n            keyPath: [\"all.toggles.forms\"],\n            value: [\" \"],\n          },\n        });\n        tools.setData({ path: \"sc.A12.forms.msgs.msg1\", value: \"\" });\n        tools.setData({\n          path: \"sc.A12.forms.iptsChanges\",\n          value: { partnerName: \"\", partnerMail: \"\", partnerActivity: \"\" },\n        });\n      };\n\n      setTimeout(delay, 2500);\n    };\n    // ---------------- fim função auxiliar\n\n    // Auth\n    const {\n      getAuth,\n      createUserWithEmailAndPassword,\n      updateProfile,\n      sendPasswordResetEmail,\n    } = await import(\"firebase/auth\");\n\n    const fbInit = tools.getCtData(\"all.temp.fireInit\");\n    console.log({ fbInit });\n    const auth = fbInit ? getAuth(fbInit) : getAuth();\n\n    const condoId =\n      tools.getCtData(\"sc.A11.forms.iptsChanges.condoData.docId\") ?? \"\";\n    if (!condoId) {\n      tools.setData({ path: \"sc.A12.forms.showErr\", value: true });\n      tools.setData({\n        path: \"sc.A12.msgs.msg1\",\n        value: \"Selecione um condomínio antes de salvar.\",\n      });\n      return;\n    }\n\n    const tempPass = \"123456\"; // senha padrão temporária\n    console.log({ tempPass });\n\n    // ====== TENTA CRIAR USUÁRIO NO AUTH ======\n    const cred = await createUserWithEmailAndPassword(auth, email, tempPass);\n    console.log({ cred });\n\n    if (name) {\n      await updateProfile(cred.user, { displayName: name });\n    }\n\n    // ====== CRIAR DOC EM 'users' PARA NOVO USUÁRIO ======\n    {\n      const {\n        getFirestore,\n        doc,\n        setDoc,\n        serverTimestamp,\n      } = await import(\"firebase/firestore\");\n      const db = fbInit ? getFirestore(fbInit) : getFirestore();\n\n      const uid = cred.user.uid;\n\n      const dataToSet = {\n        docId: uid,\n        createdAt: serverTimestamp(),\n        userName: name,\n        userEmail: email,\n        userImage: cred.user.photoURL || \"\",\n        partnerActivity,\n        typeAccount: \"partner\",\n        condoId: condoId,            // campo antigo (se você ainda usa em algum lugar)\n        condoIds: [condoId],         // novo array de condos\n      };\n\n      await setDoc(doc(db, \"users\", uid), dataToSet, { merge: true });\n      console.log(\"users doc criado/atualizado (novo parceiro):\", {\n        uid,\n        dataToSet,\n      });\n    }\n\n    // (opcional) enviar verificação / redefinição de senha\n    const host = \"http://localhost:5173\";\n    // const host = \"http://projeto-plante-uma-casa.web.app\";\n\n    const acs = {\n      url: host + \"/auth/complete-signup\",\n      handleCodeInApp: false,\n    };\n    await sendPasswordResetEmail(auth, email, acs);\n\n    tools.setData({ path: \"sc.A12.forms.showErr\", value: false });\n    tools.setData({ path: \"sc.A12.forms.showSuccess\", value: true });\n    tools.setData({\n      path: \"sc.A12.forms.msgs.msg1\",\n      value: \"Usuário criado com sucesso!\",\n    });\n\n    // Limpar mensagens após 2 segundos\n    const delay = () => {\n      tools.setData({ path: \"all.toggles.sideRight\", value: false });\n      // close Form\n      tools.functions.setVar({\n        args: \"\",\n        pass: {\n          keyPath: [\"all.toggles.forms\"],\n          value: [\" \"],\n        },\n      });\n      tools.setData({ path: \"sc.A12.forms.msgs.msg1\", value: \"\" });\n      tools.setData({\n        path: \"sc.A12.forms.iptsChanges\",\n        value: { partnerName: \"\", partnerMail: \"\", partnerActivity: \"\" },\n      });\n    };\n\n    setTimeout(delay, 2500);\n\n    // sucesso...\n  } catch (e: any) {\n    console.log(\"Erro ao criar usuário:\", e?.code, e?.message);\n\n    // se já existe no Auth, apenas vincula o condomínio ao parceiro existente\n    if (e?.code === \"auth/email-already-in-use\") {\n      await vincularCondoEmUserExistente(\n        (tools.getCtData(\"sc.A12.forms.iptsChanges.partnerMail\") ?? \"\").trim()\n      );\n      return;\n    }\n\n    tools.setData({ path: \"sc.A12.forms.showErr\", value: true });\n    tools.setData({\n      path: \"sc.A12.msgs.msg1\",\n      value: \"Erro ao Criar Parceiro. \" + (e?.message ?? \"\"),\n    });\n  }\n}","newValue":"async () => {\n  // ---------------- função auxiliar: vincular condomínio a parceiro já existente\n  const vincularCondoEmUserExistente = async (params: {\n    email: string;\n    condoId: string;\n    fbInit: any;\n  }) => {\n    const { email, condoId, fbInit } = params;\n    console.log(\"Vinculando condomínio a usuário já existente:\", {\n      email,\n      condoId,\n    });\n\n    const {\n      getFirestore,\n      collection,\n      query,\n      where,\n      getDocs,\n      doc,\n      updateDoc,\n      arrayUnion,\n    } = await import(\"firebase/firestore\");\n\n    const db = fbInit ? getFirestore(fbInit) : getFirestore();\n\n    if (!condoId) {\n      console.warn(\"Nenhum condoId selecionado para vincular.\");\n      tools.setData({ path: \"sc.A12.forms.showErr\", value: true });\n      tools.setData({\n        path: \"sc.A12.msgs.msg1\",\n        value: \"Nenhum condomínio selecionado para vincular.\",\n      });\n      return;\n    }\n\n    const q = query(\n      collection(db, \"users\"),\n      where(\"userEmail\", \"==\", email)\n    );\n\n    const snap = await getDocs(q);\n\n    if (snap.empty) {\n      console.warn(\"Usuário existe no Auth, mas não está em 'users'.\");\n      tools.setData({ path: \"sc.A12.forms.showErr\", value: true });\n      tools.setData({\n        path: \"sc.A12.msgs.msg1\",\n        value:\n          \"Usuário existe no Auth, mas não foi encontrado na base de usuários.\",\n      });\n      return;\n    }\n\n    const userDoc = snap.docs[0];\n    const uid = userDoc.id;\n    const userRef = doc(db, \"users\", uid);\n\n    await updateDoc(userRef, {\n      condoIds: arrayUnion(condoId),\n    });\n\n    console.log(\"Condomínio vinculado ao user existente:\", {\n      uid,\n      condoId,\n    });\n\n    // feedback de sucesso\n    tools.setData({ path: \"sc.A12.forms.showErr\", value: false });\n    tools.setData({ path: \"sc.A12.forms.showSuccess\", value: true });\n    tools.setData({\n      path: \"sc.A12.forms.msgs.msg1\",\n      value: \"Condomínio vinculado ao parceiro existente!\",\n    });\n\n    const delay = () => {\n      tools.setData({ path: \"all.toggles.sideRight\", value: false });\n      tools.functions.setVar({\n        args: \"\",\n        pass: {\n          keyPath: [\"all.toggles.forms\"],\n          value: [\" \"],\n        },\n      });\n      tools.setData({ path: \"sc.A12.forms.msgs.msg1\", value: \"\" });\n      tools.setData({\n        path: \"sc.A12.forms.iptsChanges\",\n        value: { partnerName: \"\", partnerMail: \"\", partnerActivity: \"\" },\n      });\n    };\n\n    setTimeout(delay, 2500);\n  };\n  // ---------------- fim função auxiliar\n\n  try {\n    const pathName = \"sc.A12.forms.iptsChanges.partnerName\";\n    const pathEmail = \"sc.A12.forms.iptsChanges.partnerMail\";\n    const pathPartner = \"sc.A12.forms.iptsChanges.partnerActivity\";\n\n    const name = (tools.getCtData(pathName) ?? \"\").trim();\n    const email = (tools.getCtData(pathEmail) ?? \"\").trim();\n    const partnerActivity = (tools.getCtData(pathPartner) ?? \"\").trim();\n    console.log({ name, email });\n\n    const validateEmail = (v: string) => v.includes(\"@\") && v.includes(\".\");\n    console.log({ validateEmail: validateEmail(email) });\n\n    if (name === \"\") {\n      tools.setData({ path: \"sc.A12.forms.showErr\", value: true });\n      tools.setData({ path: \"sc.A12.msgs.msg1\", value: \"Preencha o Nome.\" });\n      return;\n    }\n    if (email === \"\") {\n      tools.setData({ path: \"sc.A12.forms.showErr\", value: true });\n      tools.setData({ path: \"sc.A12.msgs.msg1\", value: \"Preencha o Email.\" });\n      return;\n    }\n\n    if (!validateEmail(email)) {\n      tools.setData({ path: \"sc.A12.forms.showErr\", value: true });\n      tools.setData({ path: \"sc.A12.msgs.msg1\", value: \"Email inválido.\" });\n      return;\n    }\n\n    const condoId =\n      tools.getCtData(\"sc.A11.forms.iptsChanges.condoData.docId\") ?? \"\";\n    if (!condoId) {\n      tools.setData({ path: \"sc.A12.forms.showErr\", value: true });\n      tools.setData({\n        path: \"sc.A12.msgs.msg1\",\n        value: \"Selecione um condomínio antes de salvar.\",\n      });\n      return;\n    }\n\n    // Auth\n    const {\n      getAuth,\n      createUserWithEmailAndPassword,\n      updateProfile,\n      sendPasswordResetEmail,\n    } = await import(\"firebase/auth\");\n\n    const fbInit = tools.getCtData(\"all.temp.fireInit\");\n    console.log({ fbInit });\n    const auth = fbInit ? getAuth(fbInit) : getAuth();\n\n    const tempPass = \"123456\"; // senha padrão temporária\n    console.log({ tempPass });\n\n    // ====== TENTA CRIAR USUÁRIO NO AUTH ======\n    const cred = await createUserWithEmailAndPassword(auth, email, tempPass);\n    console.log({ cred });\n\n    if (name) {\n      await updateProfile(cred.user, { displayName: name });\n    }\n\n    // ====== CRIAR DOC EM 'users' PARA NOVO USUÁRIO ======\n    {\n      const {\n        getFirestore,\n        doc,\n        setDoc,\n        serverTimestamp,\n      } = await import(\"firebase/firestore\");\n      const db = fbInit ? getFirestore(fbInit) : getFirestore();\n\n      const uid = cred.user.uid;\n\n      const dataToSet = {\n        docId: uid,\n        createdAt: serverTimestamp(),\n        userName: name,\n        userEmail: email,\n        userImage: cred.user.photoURL || \"\",\n        partnerActivity,\n        typeAccount: \"partner\",\n        condoId: condoId,      // se ainda precisar manter legado\n        condoIds: [condoId],   // novo array\n      };\n\n      await setDoc(doc(db, \"users\", uid), dataToSet, { merge: true });\n      console.log(\"users doc criado/atualizado (novo parceiro):\", {\n        uid,\n        dataToSet,\n      });\n    }\n\n    // enviar e-mail para definir senha\n    const host = \"http://localhost:5173\";\n    // const host = \"http://projeto-plante-uma-casa.web.app\";\n\n    const acs = {\n      url: host + \"/auth/complete-signup\",\n      handleCodeInApp: false,\n    };\n    await sendPasswordResetEmail(auth, email, acs);\n\n    tools.setData({ path: \"sc.A12.forms.showErr\", value: false });\n    tools.setData({ path: \"sc.A12.forms.showSuccess\", value: true });\n    tools.setData({\n      path: \"sc.A12.forms.msgs.msg1\",\n      value: \"Usuário criado com sucesso!\",\n    });\n\n    const delay = () => {\n      tools.setData({ path: \"all.toggles.sideRight\", value: false });\n      tools.functions.setVar({\n        args: \"\",\n        pass: {\n          keyPath: [\"all.toggles.forms\"],\n          value: [\" \"],\n        },\n      });\n      tools.setData({ path: \"sc.A12.forms.msgs.msg1\", value: \"\" });\n      tools.setData({\n        path: \"sc.A12.forms.iptsChanges\",\n        value: { partnerName: \"\", partnerMail: \"\", partnerActivity: \"\" },\n      });\n    };\n\n    setTimeout(delay, 2500);\n  } catch (e: any) {\n    console.log(\"Erro ao criar usuário:\", e?.code, e?.message);\n\n    if (e?.code === \"auth/email-already-in-use\") {\n      const email =\n        (tools.getCtData(\"sc.A12.forms.iptsChanges.partnerMail\") ?? \"\").trim();\n      const condoId =\n        tools.getCtData(\"sc.A11.forms.iptsChanges.condoData.docId\") ?? \"\";\n      const fbInit = tools.getCtData(\"all.temp.fireInit\");\n\n      await vincularCondoEmUserExistente({ email, condoId, fbInit });\n      return;\n    }\n\n    tools.setData({ path: \"sc.A12.forms.showErr\", value: true });\n    tools.setData({\n      path: \"sc.A12.msgs.msg1\",\n      value: \"Erro ao Criar Parceiro. \" + (e?.message ?? \"\"),\n    });\n  }\n}"}}