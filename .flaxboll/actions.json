{"1769193968303":{"actionType":"saveAll","createdAt":"1769193968303","actionID":"1769193968303","userID":"#TEMP","path":"system.capsules.7afb4a91-2a5b-42ff-aebd-05b195034998.capsUseCodeInfo.capsUseInputs.sss_freeValue-0.capsIptTxtValue","oldValue":"// ---------- import React Packs\nimport React from \"react\";\nimport * as RN from \"react-native\";\n\nimport { getAuth } from \"firebase/auth\";\nimport {\n  arrayUnion,\n  doc,\n  getFirestore,\n  serverTimestamp,\n  setDoc,\n} from \"firebase/firestore\";\nimport { Platform, SafeAreaView, StatusBar } from \"react-native\";\n\n// ---------- import Variables Pack\n\n// ---------- import Local Tools\nimport { usePushNotifications } from \"../../customs/usePushNotifications\";\nimport { getCtData } from \"./getCtData\";\nimport { goTo } from \"./goTo\";\nimport { mapElements } from \"./mapElements\";\nimport { setData } from \"./setData\";\n\n// ---------- set Caps Inputs\ntype Tprops = {\n  configData: {\n    screens: any[];\n    initCt: Record<string, any>;\n    arrInitFuncs: (() => void)[];\n  };\n};\n\n// ---------- set Main Component\nexport const Project = ({ configData }: Tprops) => {\n  // ---------- set Data\n  const { screens, arrInitFuncs } = configData;\n  const condWeb = Platform.OS === \"web\";\n  const fallbackData = { expoPushToken: null, notification: null };\n  console.log({ fallbackData });\n  const { expoPushToken } = usePushNotifications() ?? fallbackData;\n\n  // ---------- call Redirects (If Exists)\n  // ---------- quando o token mudar, salva no Firestore\n  React.useEffect(() => {\n    if (!expoPushToken) return;\n\n    const run = async () => {\n      console.log({ expoPushToken });\n      await saveExpoPushTokenToUser(expoPushToken);\n    };\n\n    run().catch((err) =>\n      console.log(\"Project: erro ao salvar expoPushToken\", err)\n    );\n  }, [expoPushToken]);\n\n  React.useEffect(() => {\n    if (condWeb) {\n      const { pathname, search } = window.location;\n\n      if (pathname.startsWith(\"/auth/setpassword\")) {\n        const qs = Object.fromEntries(new URLSearchParams(search).entries());\n        console.log({ qs });\n\n        goTo(\"a0dsetpass\");\n\n        // guarde params para a tela usar (confirmPasswordReset etc.)\n        setData({\n          path: \"sc.A0D.forms.iptsChanges\",\n          value: {\n            mode: qs.mode,\n            oobCode: qs.oobCode,\n            continueUrl: qs.continueUrl,\n          },\n        });\n      }\n    }\n  }, []);\n\n  // ---------- call Functions (If Exists)\n  React.useEffect(() => {\n    const callFn = async () => {\n      for (const currFunc of arrInitFuncs) await currFunc();\n    };\n\n    callFn().catch((err) => console.log(\"Project Start Functions\", { err }));\n  }, []);\n\n  const baseStl: RN.ViewStyle = {\n    flexDirection: \"column\",\n    width: \"100%\",\n    height: \"100%\",\n  };\n\n  return (\n    <RN.View style={baseStl}>\n      <SafeAreaView\n        style={{ width: \"100%\", height: \"100%\", overflow: \"hidden\", backgroundColor: \"#122812\", }}\n      >\n        {mapElements(screens)}\n\n        <StatusBar barStyle={\"light-content\"} />\n      </SafeAreaView>\n    </RN.View>\n  );\n};\n\n// Salva o token no documento do usuário em `users/{uid}`\nexport async function saveExpoPushTokenToUser(expoPushToken: string | null) {\n  try {\n    if (!expoPushToken) {\n      console.log(\"saveExpoPushTokenToUser: token vazio, ignorando\");\n      return;\n    }\n\n    const fbInit = getCtData(\"all.temp.fireInit\");\n    if (!fbInit) {\n      console.log(\"saveExpoPushTokenToUser: fireInit não encontrado, abortando\");\n      return;\n    }\n\n    const auth = getAuth(fbInit);\n    const user = auth.currentUser;\n\n    if (!user) {\n      console.log(\"saveExpoPushTokenToUser: usuário não autenticado\");\n      return;\n    }\n\n    const db = getFirestore(fbInit); // usa mesma app\n    const userRef = doc(db, \"users\", user.uid);\n\n    await setDoc(\n      userRef,\n      {\n        notifications: {\n          expoPushTokens: arrayUnion({\n            token: expoPushToken,\n            platform: Platform.OS,\n            updatedAt: serverTimestamp(),\n          }),\n        },\n      },\n      { merge: true }\n    );\n\n    console.log(\"saveExpoPushTokenToUser: token salvo com sucesso\");\n  } catch (err) {\n    console.log(\"saveExpoPushTokenToUser: erro ao salvar token\", err);\n  }\n};","newValue":"// ---------- import React Packs\nimport React from \"react\";\nimport * as RN from \"react-native\";\n\nimport { getAuth } from \"firebase/auth\";\nimport {\n  arrayUnion,\n  doc,\n  getFirestore,\n  serverTimestamp,\n  setDoc,\n} from \"firebase/firestore\";\nimport { Platform, SafeAreaView, StatusBar } from \"react-native\";\n\n// ---------- import Variables Pack\n\n// ---------- import Local Tools\nimport { usePushNotifications } from \"../../customs/usePushNotifications\";\nimport { getCtData } from \"./getCtData\";\nimport { goTo } from \"./goTo\";\nimport { mapElements } from \"./mapElements\";\nimport { setData } from \"./setData\";\n\n// ---------- set Caps Inputs\ntype Tprops = {\n  configData: {\n    screens: any[];\n    initCt: Record<string, any>;\n    arrInitFuncs: (() => void)[];\n  };\n};\n\n// ---------- set Main Component\nexport const Project = ({ configData }: Tprops) => {\n  // ---------- set Data\n  const { screens, arrInitFuncs } = configData;\n  const condWeb = Platform.OS === \"web\";\n  const fallbackData = { expoPushToken: null, notification: null };\n  console.log({ fallbackData });\n  const { expoPushToken } = usePushNotifications() ?? fallbackData;\n\n  // ---------- call Redirects (If Exists)\n  // ---------- quando o token mudar, salva no Firestore\n  React.useEffect(() => {\n    if (!expoPushToken) return;\n\n    const run = async () => {\n      console.log({ expoPushToken });\n      await saveExpoPushTokenToUser(expoPushToken);\n    };\n\n    run().catch((err) =>\n      console.log(\"Project: erro ao salvar expoPushToken\", err)\n    );\n  }, [expoPushToken]);\n\n  React.useEffect(() => {\n    if (condWeb) {\n      const { pathname, search } = window.location;\n\n      if (pathname.startsWith(\"/auth/setpassword\")) {\n        const qs = Object.fromEntries(new URLSearchParams(search).entries());\n        console.log({ qs });\n\n        goTo(\"a0dsetpass\");\n\n        // guarde params para a tela usar (confirmPasswordReset etc.)\n        setData({\n          path: \"sc.A0D.forms.iptsChanges\",\n          value: {\n            mode: qs.mode,\n            oobCode: qs.oobCode,\n            continueUrl: qs.continueUrl,\n          },\n        });\n      }\n    }\n  }, []);\n\n  // ---------- call Functions (If Exists)\n  React.useEffect(() => {\n    const callFn = async () => {\n      for (const currFunc of arrInitFuncs) await currFunc();\n    };\n\n    callFn().catch((err) => console.log(\"Project Start Functions\", { err }));\n  }, []);\n\n  const baseStl: RN.ViewStyle = {\n    flexDirection: \"column\",\n    width: \"100%\",\n    height: \"100%\",\n  };\n\n  return (\n    <RN.View style={baseStl}>\n      <SafeAreaView\n        style={{ width: \"100%\", height: \"100%\", overflow: \"hidden\", backgroundColor: \"#122812\" }}\n      >\n        {mapElements(screens)}\n\n        <StatusBar barStyle={\"light-content\"} />\n      </SafeAreaView>\n    </RN.View>\n  );\n};\n\n// Salva o token no documento do usuário em `users/{uid}`\nexport async function saveExpoPushTokenToUser(expoPushToken: string | null) {\n  try {\n    if (!expoPushToken) {\n      console.log(\"saveExpoPushTokenToUser: token vazio, ignorando\");\n      return;\n    }\n\n    const fbInit = getCtData(\"all.temp.fireInit\");\n    if (!fbInit) {\n      console.log(\"saveExpoPushTokenToUser: fireInit não encontrado, abortando\");\n      return;\n    }\n\n    const auth = getAuth(fbInit);\n    const user = auth.currentUser;\n\n    if (!user) {\n      console.log(\"saveExpoPushTokenToUser: usuário não autenticado\");\n      return;\n    }\n\n    const db = getFirestore(fbInit); // usa mesma app\n    const userRef = doc(db, \"users\", user.uid);\n\n    await setDoc(\n      userRef,\n      {\n        notifications: {\n          expoPushTokens: arrayUnion({\n            token: expoPushToken,\n            platform: Platform.OS,\n            updatedAt: serverTimestamp(),\n          }),\n        },\n      },\n      { merge: true }\n    );\n\n    console.log(\"saveExpoPushTokenToUser: token salvo com sucesso\");\n  } catch (err) {\n    console.log(\"saveExpoPushTokenToUser: erro ao salvar token\", err);\n  }\n};"}}