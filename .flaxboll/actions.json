{"1762805738031":{"actionType":"saveAll","createdAt":"1762805738031","actionID":"1762805738031","userID":"#TEMP","path":"system.capsules.3757bc92-00a4-4393-a217-cd330440d3b5.capsUseCodeInfo.capsUseInputs.sss_custom_caps-0.capsIptTxtValue","oldValue":"async () => {\n  const css1 =\n    \"color: limegreen; background-color: darkcyan; font-size: 11px; padding: 2px 6px; border-radius: 3px\";\n\n  try {\n    const { getFirestore, doc, updateDoc } = await import(\"firebase/firestore\");\n    const fbInit = tools.getCtData(\"all.temp.fireInit\");\n    const db = getFirestore(fbInit);\n\n    const lotId = tools.getCtData(\"sc.A10.currents.currId1\");\n    const form = tools.getCtData(\"sc.A10.forms.editChanges\");\n\n    if (!lotId) {\n      console.warn(\"‚ùå Nenhum lote selecionado (lotId ausente)\");\n      return;\n    }\n\n    // üîπ Extrai e normaliza os campos do formul√°rio\n    const rawValue = (form?.value || \"\").toString().replace(\",\", \".\").trim();\n    const rawInstallments = (form?.numberOfInstallments || \"\")\n      .toString()\n      .trim();\n    const date = (form?.date || \"\").trim();\n    const description = (form?.description || \"\").trim();\n\n    // üîπ Converte para n√∫mero de forma segura\n    const numberOfInstallments = parseInt(rawInstallments, 10);\n    const value = parseFloat(rawValue);\n\n    if (\n      isNaN(numberOfInstallments) ||\n      isNaN(value) ||\n      numberOfInstallments <= 0 ||\n      value <= 0\n    ) {\n      console.warn(\"‚ùå N√∫mero de parcelas ou valor inv√°lido:\", {\n        numberOfInstallments,\n        value,\n        rawValue,\n        rawInstallments,\n      });\n      return;\n    }\n\n    // üîπ Calcula automaticamente o valor total\n    const calculatedTotal = value * numberOfInstallments;\n\n    const totalValue =\n      parseFloat(\n        String(form?.totalValue || \"\")\n          .replace(/[^\\d,.-]/g, \"\")\n          .replace(\",\", \".\")\n      ) || calculatedTotal;\n\n    // üîπ Monta o mapa de parcelas (installments)\n    const installmentsMap = {\n      totalValue: totalValue.toFixed(2),\n      numberOfInstallments,\n    };\n\n    // üîπ Cria um map i1, i2, i3... com os mesmos dados base\n    for (let i = 1; i <= numberOfInstallments; i++) {\n      const id = \"i\" + i;\n      installmentsMap[id] = {\n        installmentId: id,\n        date,\n        description,\n        value: value.toFixed(2),\n      };\n    }\n\n    // üîπ Atualiza o documento\n    const dataToUpdate = { installments: installmentsMap };\n    const refDoc = doc(db, \"lots\", lotId);\n    await updateDoc(refDoc, dataToUpdate);\n\n    console.log(\"%c‚úÖ Dados atualizados com sucesso:\", css1, dataToUpdate);\n\n    tools.setData({ path: \"sc.A10.forms.editChanges\", value: {} });\n    tools.setData({ path: \"all.toggles.sideRight\", value: false });\n    tools.setData({ path: \"all.toggles.a10.addFinance\", value: false });\n\n    tools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"sc.A10.feedbackMessage\"],\n        value: [\n          \"üíæ Parcelas geradas e salvas com sucesso! Total: R$ \" +\n            totalValue.toFixed(2),\n        ],\n      },\n    });\n  } catch (err) {\n    console.error(\"‚ùå Erro ao salvar no Firebase:\", err);\n    tools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"sc.A10.feedbackMessage\"],\n        value: [\"‚ö†Ô∏è Erro ao salvar. Verifique o console.\"],\n      },\n    });\n  }\n};","newValue":"async () => {\n  const css1 =\n    \"color: limegreen; background-color: darkcyan; font-size: 11px; padding: 2px 6px; border-radius: 3px\";\n\n  try {\n    const { getFirestore, doc, updateDoc } = await import(\"firebase/firestore\");\n    const fbInit = tools.getCtData(\"all.temp.fireInit\");\n    const db = getFirestore(fbInit);\n\n    const lotId = tools.getCtData(\"sc.A10.currents.currId1\");\n    const form = tools.getCtData(\"sc.A10.forms.editChanges\");\n\n    if (!lotId) {\n      console.warn(\"‚ùå Nenhum lote selecionado (lotId ausente)\");\n      return;\n    }\n\n    // üîπ Extrai e normaliza os campos do formul√°rio\n    const rawValue = (form?.value || \"\").toString().replace(\",\", \".\").trim();\n    const rawInstallments = (form?.numberOfInstallments || \"\")\n      .toString()\n      .trim();\n    const date = (form?.date || \"\").trim();\n    const description = (form?.description || \"\").trim();\n\n    // üîπ Converte para n√∫mero de forma segura\n    const numberOfInstallments = parseInt(rawInstallments, 10);\n    const value = parseFloat(rawValue);\n\n    if (\n      isNaN(numberOfInstallments) ||\n      isNaN(value) ||\n      numberOfInstallments <= 0 ||\n      value <= 0\n    ) {\n      console.warn(\"‚ùå N√∫mero de parcelas ou valor inv√°lido:\", {\n        numberOfInstallments,\n        value,\n        rawValue,\n        rawInstallments,\n      });\n      return;\n    }\n\n    // üîπ Calcula automaticamente o valor total\n    const calculatedTotal = value * numberOfInstallments;\n\n    const totalValue =\n      parseFloat(\n        String(form?.totalValue || \"\")\n          .replace(/[^\\d,.-]/g, \"\")\n          .replace(\",\", \".\")\n      ) || calculatedTotal;\n\n    // üîπ Monta o mapa de parcelas (installments)\n    const installmentsMap = {\n      totalValue: totalValue.toFixed(2),\n      numberOfInstallments,\n    };\n\n    // üîπ Cria um map i1, i2, i3... com os mesmos dados base\n    for (let i = 1; i <= numberOfInstallments; i++) {\n      const id = \"i\" + i;\n      installmentsMap[id] = {\n        installmentId: id,\n        date,\n        description,\n        value: value.toFixed(2),\n      };\n    }\n\n    // üîπ Atualiza o documento\n    const dataToUpdate = { installments: installmentsMap };\n    const refDoc = doc(db, \"lots\", lotId);\n    await updateDoc(refDoc, dataToUpdate);\n\n    console.log(\"%c‚úÖ Dados atualizados com sucesso:\", css1, dataToUpdate);\n\n    tools.setData({ path: \"sc.A10.forms.editChanges\", value: {} });\n    tools.setData({ path: \"all.toggles.sideRight\", value: false });\n    tools.setData({ path: \"all.toggles.a10.addFinance\", value: false });\n\n    tools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"sc.A10.feedbackMessage\"],\n        value: [\n          \"üíæ Parcelas geradas e salvas com sucesso! Total: R$ \" +\n            totalValue.toFixed(2),\n        ],\n      },\n    });\n  } catch (err) {\n    console.error(\"‚ùå Erro ao salvar no Firebase:\", err);\n    tools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"sc.A10.feedbackMessage\"],\n        value: [\"‚ö†Ô∏è Erro ao salvar. Verifique o console.\"],\n      },\n    });\n  }\n}"}}