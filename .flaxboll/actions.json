{"1762363733423":{"actionType":"saveAll","createdAt":"1762363733423","actionID":"1762363733423","userID":"#TEMP","path":"system.capsules.3757bc92-00a4-4393-a217-cd330440d3b5.capsUseCodeInfo.capsUseInputs.sss_custom_caps-0.capsIptTxtValue","oldValue":"async () => {\n  const css1 =\n    \"color: limegreen; background-color: darkcyan; font-size: 11px; padding: 2px 6px; border-radius: 3px\";\n\n  try {\n    // ğŸ”¹ Inicializa o Firestore\n    const { getFirestore, doc, updateDoc } = await import(\"firebase/firestore\");\n    const fbInit = tools.getCtData(\"all.temp.fireInit\");\n    const db = getFirestore(fbInit);\n\n    // ğŸ”¹ ObtÃ©m o ID do lote e os dados do formulÃ¡rio\n    const lotId = tools.getCtData(\"sc.A10.currents.currId1\");\n    const form = tools.getCtData(\"sc.A10.forms.editChanges\");\n\n    if (!lotId) {\n      console.warn(\"âŒ Nenhum lote selecionado (lotId ausente)\");\n      return;\n    }\n\n    // ğŸ”¹ Extrai os valores do formulÃ¡rio\n    const numberOfInstallments = form?.numberOfInstallments ?? \"\";\n    const totalValue = form?.totalValue ?? \"\";\n    const date = form?.date ?? \"\";\n    const description = form?.description ?? \"\";\n    const value = form?.value ?? \"\";\n\n    // ğŸ”¹ Monta o mapa do primeiro installment (i1)\n    const installmentData = {\n      installmentId: \"i1\",\n      date,\n      description,\n      value,\n    };\n\n    // ğŸ”¹ Monta o objeto de atualizaÃ§Ã£o\n    const dataToUpdate = {\n      numberOfInstallments,\n      totalValue,\n      [\"installments.\" + form.installmentId]: installmentData\n    };\n\n    // ğŸ”¹ Atualiza o documento\n    const refDoc = doc(db, \"lots\", lotId);\n    await updateDoc(refDoc, dataToUpdate);\n\n    console.log(\"%câœ… Dados atualizados com sucesso:\", css1, dataToUpdate);\n\n    // ğŸ”¹ Limpa o formulÃ¡rio e fecha o painel\n    tools.setData({ path: \"sc.A10.forms.editChanges\", value: {} });\n    tools.setData({ path: \"all.toggles.sideRight\", value: false });\n    tools.setData({ path: \"all.toggles.a10.addFinance\", value: false });\n\n    // ğŸ”¹ Feedback opcional na tela\n    tools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"sc.A10.feedbackMessage\"],\n        value: [\"ğŸ’¾ Dados salvos com sucesso!\"],\n      },\n    });\n  } catch (err) {\n    console.error(\"âŒ Erro ao salvar no Firebase:\", err);\n\n    tools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"sc.A10.feedbackMessage\"],\n        value: [\"âš ï¸ Erro ao salvar. Verifique o console.\"],\n      },\n    });\n  }\n}","newValue":"async () => {\n  const css1 =\n    \"color: limegreen; background-color: darkcyan; font-size: 11px; padding: 2px 6px; border-radius: 3px\";\n\n  try {\n    // ğŸ”¹ Inicializa o Firestore\n    const { getFirestore, doc, updateDoc } = await import(\"firebase/firestore\");\n    const fbInit = tools.getCtData(\"all.temp.fireInit\");\n    const db = getFirestore(fbInit);\n\n    // ğŸ”¹ ObtÃ©m o ID do lote e os dados do formulÃ¡rio\n    const lotId = tools.getCtData(\"sc.A10.currents.currId1\");\n    const form = tools.getCtData(\"sc.A10.forms.editChanges\");\n\n    if (!lotId) {\n      console.warn(\"âŒ Nenhum lote selecionado (lotId ausente)\");\n      return;\n    }\n\n    // ğŸ”¹ Extrai os valores do formulÃ¡rio com fallback seguro\n    const numberOfInstallments = form?.numberOfInstallments || \"\";\n    const totalValue = form?.totalValue || \"\";\n    const date = form?.date || \"\";\n    const description = form?.description || \"\";\n    const value = form?.value || \"\";\n    const installmentId = form?.installmentId || \"i1\"; // ğŸ‘ˆ garante um valor vÃ¡lido\n\n    // ğŸ”¹ Monta o mapa do installment\n    const installmentData = {\n      installmentId,\n      date,\n      description,\n      value,\n    };\n\n    // ğŸ”¹ Monta o objeto de atualizaÃ§Ã£o\n    const dataToUpdate = {\n      numberOfInstallments,\n      totalValue,\n      [\"installments.\" + installmentId]: installmentData, // ğŸ‘ˆ evita 'undefined'\n    };\n\n    // ğŸ”¹ Atualiza o documento no Firestore\n    const refDoc = doc(db, \"lots\", lotId);\n    await updateDoc(refDoc, dataToUpdate);\n\n    console.log(\"%câœ… Dados atualizados com sucesso:\", css1, dataToUpdate);\n\n    // ğŸ”¹ Limpa o formulÃ¡rio e fecha o painel\n    tools.setData({ path: \"sc.A10.forms.editChanges\", value: {} });\n    tools.setData({ path: \"all.toggles.sideRight\", value: false });\n    tools.setData({ path: \"all.toggles.a10.addFinance\", value: false });\n\n    // ğŸ”¹ Feedback opcional\n    tools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"sc.A10.feedbackMessage\"],\n        value: [\"ğŸ’¾ Dados salvos com sucesso!\"],\n      },\n    });\n  } catch (err) {\n    console.error(\"âŒ Erro ao salvar no Firebase:\", err);\n\n    tools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"sc.A10.feedbackMessage\"],\n        value: [\"âš ï¸ Erro ao salvar. Verifique o console.\"],\n      },\n    });\n  }\n};\n"}}