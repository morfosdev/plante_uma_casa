{"1763561292796":{"actionType":"saveAll","createdAt":"1763561292796","actionID":"1763561292796","userID":"#TEMP","path":"system.capsules.a228cf42-4f11-42e1-9cf2-24b90a7f0b46.capsUseCodeInfo.capsUseInputs.sss_custom_caps-0.capsIptTxtValue","oldValue":"async () => {\n  const requiredFields = [\n    { path: \"sc.a1.editChanges.condo\", name: \"Nome do Condom√≠nio\" },\n    { path: \"sc.a1.editChanges.address\", name: \"Endere√ßo\" },\n    { path: \"sc.a1.editChanges.startDate\", name: \"Data de In√≠cio\" },\n    { path: \"sc.a1.editChanges.endDate\", name: \"Data de Conclus√£o Prevista\" },\n    { path: \"sc.a1.editChanges.description\", name: \"Descri√ß√£o\" },\n  ];\n\n  const getVal = (path) => {\n    const val = tools.getCtData(path);\n    if (val === null || val === undefined) return \"\";\n    if (Array.isArray(val)) return val[0] ?? \"\";\n    return val;\n  };\n\n  const getArrayVal = (path) => {\n    let val = tools.getCtData(path);\n    if (!val) return []; // üîπ Retorna array vazio se n√£o houver nada\n    if (Array.isArray(val)) return val;\n    if (typeof val === \"string\") {\n      try {\n        const parsed = JSON.parse(val);\n        return Array.isArray(parsed) ? parsed : [parsed];\n      } catch {\n        return [val]; // üîπ Se n√£o for JSON v√°lido, transforma em array simples\n      }\n    }\n    return [val];\n  };\n\n  // üîπ Verifica campos obrigat√≥rios\n  const emptyFields = requiredFields.filter((f) => {\n    const v = getVal(f.path);\n    return v === \"\" || v === null || v === undefined;\n  });\n\n  if (emptyFields.length > 0) {\n    tools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"sc.a1.validationMessage\"],\n        value: [\"Preencha os campos obrigat√≥rios.\"],\n      },\n    });\n    console.warn(\"‚ö†Ô∏è Campos vazios detectados:\", emptyFields.map(f => f.name).join(\", \"));\n    return;\n  }\n\n  console.log(\"üíæ Valida√ß√£o OK ‚Äî atualizando documento no Firebase...\");\n\n  // üîπ Inicializa o Firebase\n  let fbInit = tools.getCtData(\"all.temp.fireInit\");\n  if (!fbInit) {\n    const { initializeApp, getApps } = await import(\"firebase/app\");\n    const cfg = tools.getCtData(\"all.temp.fireConfig\") ?? {};\n    fbInit = getApps().length ? getApps()[0] : initializeApp(cfg);\n    tools.setData({ path: \"all.temp.fireInit\", value: fbInit });\n  }\n\n  const { getFirestore, doc, updateDoc, serverTimestamp } = await import(\"firebase/firestore\");\n  const db = getFirestore(fbInit);\n\n  const docId = tools.getCtData(\"sc.a1.editChanges.docId\");\n\n  if (!docId || typeof docId !== \"string\") {\n    console.error(\"‚ùå ID do documento inv√°lido:\", docId);\n    tools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"sc.a1.validationMessage\"],\n        value: [\"ID do documento inv√°lido. N√£o foi poss√≠vel atualizar.\"],\n      },\n    });\n    return;\n  }\n\n  // üîπ Monta o objeto para atualiza√ß√£o\n  const updatedDoc = {\n    condo: getVal(\"sc.a1.editChanges.condo\"),\n    address: getVal(\"sc.a1.editChanges.address\"),\n    startDate: getVal(\"sc.a1.editChanges.startDate\"),\n    endDate: getVal(\"sc.a1.editChanges.endDate\"),\n    description: getVal(\"sc.a1.editChanges.description\"),\n    images: getArrayVal(\"sc.a1.editChanges.images\"), // üîπ Trata como array garantido\n    files: getArrayVal(\"sc.a1.editChanges.documents\"), // üîπ Trata como array garantido\n    updatedAt: serverTimestamp(),\n  };\n\n  try {\n    await updateDoc(doc(db, \"condos\", docId), updatedDoc);\n    console.log(\"‚úÖ Documento atualizado com sucesso:\", updatedDoc);\n\n    tools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"sc.a1.validationMessage\"],\n        value: [\"üè¢ Dados atualizados com sucesso!\"],\n      },\n    });\n\n    // üîπ Limpa formul√°rio e fecha pain√©is\n    tools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"sc.a1.editChanges\"],\n        value: [{}],\n      },\n    });\n\n    //close Form\ntools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"all.toggles.forms\"],\n        value: [\" \"],\n      },\n    });tools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"all.toggles.forms\"],\n        value: [false],\n      },\n    });\n\n    tools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"all.toggles.sideRight\"],\n        value: [false],\n      },\n    });\n  } catch (error) {\n    console.error(\"‚ùå Erro ao atualizar documento:\", error);\n    tools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"sc.a1.validationMessage\"],\n        value: [\"Erro ao atualizar os dados. Verifique o console.\"],\n      },\n    });\n  }\n\n  // üîπ Limpa mensagens ap√≥s o processo\n  tools.functions.setVar({\n    args: \"\",\n    pass: {\n      keyPath: [\"sc.a1.validationMessage\"],\n      value: [\"\"],\n    },\n  });\n}\n","newValue":"async () => {\n  const requiredFields = [\n    { path: \"sc.a1.editChanges.condo\", name: \"Nome do Condom√≠nio\" },\n    { path: \"sc.a1.editChanges.address\", name: \"Endere√ßo\" },\n    { path: \"sc.a1.editChanges.startDate\", name: \"Data de In√≠cio\" },\n    { path: \"sc.a1.editChanges.endDate\", name: \"Data de Conclus√£o Prevista\" },\n    { path: \"sc.a1.editChanges.description\", name: \"Descri√ß√£o\" },\n  ];\n\n  const getVal = (path) => {\n    const val = tools.getCtData(path);\n    if (val === null || val === undefined) return \"\";\n    if (Array.isArray(val)) return val[0] ?? \"\";\n    return val;\n  };\n\n  const getArrayVal = (path) => {\n    let val = tools.getCtData(path);\n    if (!val) return []; // üîπ Retorna array vazio se n√£o houver nada\n    if (Array.isArray(val)) return val;\n    if (typeof val === \"string\") {\n      try {\n        const parsed = JSON.parse(val);\n        return Array.isArray(parsed) ? parsed : [parsed];\n      } catch {\n        return [val]; // üîπ Se n√£o for JSON v√°lido, transforma em array simples\n      }\n    }\n    return [val];\n  };\n\n  // üîπ Verifica campos obrigat√≥rios\n  const emptyFields = requiredFields.filter((f) => {\n    const v = getVal(f.path);\n    return v === \"\" || v === null || v === undefined;\n  });\n\n  if (emptyFields.length > 0) {\n    tools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"sc.a1.validationMessage\"],\n        value: [\"Preencha os campos obrigat√≥rios.\"],\n      },\n    });\n    console.warn(\"‚ö†Ô∏è Campos vazios detectados:\", emptyFields.map(f => f.name).join(\", \"));\n    return;\n  }\n\n  console.log(\"üíæ Valida√ß√£o OK ‚Äî atualizando documento no Firebase...\");\n\n  // üîπ Inicializa o Firebase\n  let fbInit = tools.getCtData(\"all.temp.fireInit\");\n  if (!fbInit) {\n    const { initializeApp, getApps } = await import(\"firebase/app\");\n    const cfg = tools.getCtData(\"all.temp.fireConfig\") ?? {};\n    fbInit = getApps().length ? getApps()[0] : initializeApp(cfg);\n    tools.setData({ path: \"all.temp.fireInit\", value: fbInit });\n  }\n\n  const { getFirestore, doc, updateDoc, serverTimestamp } = await import(\"firebase/firestore\");\n  const db = getFirestore(fbInit);\n\n  const docId = tools.getCtData(\"sc.a1.editChanges.docId\");\n\n  if (!docId || typeof docId !== \"string\") {\n    console.error(\"‚ùå ID do documento inv√°lido:\", docId);\n    tools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"sc.a1.validationMessage\"],\n        value: [\"ID do documento inv√°lido. N√£o foi poss√≠vel atualizar.\"],\n      },\n    });\n    return;\n  }\n\n  // üîπ Monta o objeto para atualiza√ß√£o\n  const updatedDoc = {\n    condo: getVal(\"sc.a1.editChanges.condo\"),\n    address: getVal(\"sc.a1.editChanges.address\"),\n    startDate: getVal(\"sc.a1.editChanges.startDate\"),\n    endDate: getVal(\"sc.a1.editChanges.endDate\"),\n    description: getVal(\"sc.a1.editChanges.description\"),\n    images: getArrayVal(\"sc.a1.editChanges.images\"), // üîπ Trata como array garantido\n    files: getArrayVal(\"sc.a1.editChanges.documents\"), // üîπ Trata como array garantido\n    updatedAt: serverTimestamp(),\n  };\n\n  try {\n    await updateDoc(doc(db, \"condos\", docId), updatedDoc);\n    console.log(\"‚úÖ Documento atualizado com sucesso:\", updatedDoc);\n\n    tools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"sc.a1.validationMessage\"],\n        value: [\"üè¢ Dados atualizados com sucesso!\"],\n      },\n    });\n\n    // üîπ Limpa formul√°rio e fecha pain√©is\n    tools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"sc.a1.editChanges\"],\n        value: [{}],\n      },\n    });\n\n    //close Form\ntools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"all.toggles.forms\"],\n        value: [\" \"],\n      },\n    });\n\n    tools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"all.toggles.sideRight\"],\n        value: [false],\n      },\n    });\n  } catch (error) {\n    console.error(\"‚ùå Erro ao atualizar documento:\", error);\n    tools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"sc.a1.validationMessage\"],\n        value: [\"Erro ao atualizar os dados. Verifique o console.\"],\n      },\n    });\n  }\n\n  // üîπ Limpa mensagens ap√≥s o processo\n  tools.functions.setVar({\n    args: \"\",\n    pass: {\n      keyPath: [\"sc.a1.validationMessage\"],\n      value: [\"\"],\n    },\n  });\n}\n"},"1763561292797":{"actionType":"saveAll","createdAt":"1763561292797","actionID":"1763561292797","userID":"#TEMP","path":"system.capsules.fc90c336-ef21-4c24-a9b4-9b48689a4633.capsUseCodeInfo.capsUseInputs.sss_custom_caps-0.capsIptTxtValue","oldValue":"async () => {\n  const requiredFields = [\n    { path: \"sc.A7.forms.iptsChanges.partnerName\", name: \"Nome do Propriet√°rio\" },\n    { path: \"sc.A7.forms.iptsChanges.partnerMail\", name: \"E-mail\" },\n    { path: \"sc.A7.forms.iptsChanges.lot\", name: \"Obra\" },\n    { path: \"sc.A7.forms.iptsChanges.area\", name: \"√Årea\" },\n    { path: \"sc.A7.forms.iptsChanges.totalValue\", name: \"Valor total da obra\" },\n    { path: \"sc.A7.forms.iptsChanges.firstInstallment\", name: \"Valor total da entrada\" },\n  ];\n\n  const getVal = (path) => {\n    const val = tools.getCtData(path);\n    if (Array.isArray(val)) return val[0] ?? \"\";\n    return val ?? \"\";\n  };\n\n  const emptyFields = requiredFields.filter((f) => {\n    const v = getVal(f.path);\n    return v === \"\" || v === null || v === undefined;\n  });\n\n  if (emptyFields.length > 0) {\n    tools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"sc.a7.validationMessage\"],\n        value: [\"Preencha os campos obrigat√≥rios.\"],\n      },\n    });\n    console.warn(\"Campos vazios:\", emptyFields.map((f) => f.name).join(\", \"));\n    return;\n  }\n\n  console.log(\"üíæ Iniciando salvamento no Firebase...\");\n\n  // Inicializa o Firebase se ainda n√£o estiver pronto\n  let fbInit = tools.getCtData(\"all.temp.fireInit\");\n  if (!fbInit) {\n    const { initializeApp, getApps } = await import(\"firebase/app\");\n    const cfg = tools.getCtData(\"all.temp.fireConfig\");\n    fbInit = getApps().length ? getApps()[0] : initializeApp(cfg);\n    tools.setData({ path: \"all.temp.fireInit\", value: fbInit });\n  }\n\n  const {\n    getFirestore,\n    collection,\n    doc,\n    setDoc,\n    addDoc,\n    updateDoc,\n    query,\n    where,\n    getDocs,\n    serverTimestamp,\n  } = await import(\"firebase/firestore\");\n\n  const db = getFirestore(fbInit);\n\n  // Pega dados do formul√°rio\n  const email = getVal(\"sc.A7.forms.iptsChanges.partnerMail\");\n  const name = getVal(\"sc.A7.forms.iptsChanges.partnerName\");\n  const condoId = getVal(\"sc.A7.forms.iptsChanges.condoData.docId\");\n\n  if (!condoId) {\n    tools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"sc.a7.validationMessage\"],\n        value: [\"‚ö†Ô∏è Selecione um condom√≠nio antes de salvar.\"],\n      },\n    });\n    console.warn(\"Condom√≠nio ausente.\");\n    return;\n  }\n\n  // Busca usu√°rio existente\n  const usersRef = collection(db, \"users\");\n  const q = query(usersRef, where(\"userEmail\", \"==\", email));\n  const querySnapshot = await getDocs(q);\n\n  let ownerId;\n  let userExists = false;\n\n  if (!querySnapshot.empty) {\n    userExists = true;\n    const userDoc = querySnapshot.docs[0];\n    ownerId = userDoc.id;\n    console.log(\"‚úÖ Usu√°rio existente encontrado:\", ownerId);\n  } else {\n    console.log(\"üÜï Criando novo usu√°rio...\");\n    const newUserRef = doc(collection(db, \"users\"));\n    ownerId = newUserRef.id;\n\n    await setDoc(newUserRef, {\n      docId: ownerId,\n      userEmail: email,\n      userName: name,\n      createdAt: serverTimestamp(),\n    });\n\n    console.log(\"‚úÖ Novo usu√°rio criado com docId:\", ownerId);\n  }\n\n  // Cria o lote vinculado ao propriet√°rio\n  const lotsRef = collection(db, \"lots\");\n  const newLot = {\n    owner: name,\n    userEmail: email,\n    ownerId: ownerId,\n    lot: getVal(\"sc.A7.forms.iptsChanges.lot\"),\n    area: getVal(\"sc.A7.forms.iptsChanges.area\"),\n    totalValue: getVal(\"sc.A7.forms.iptsChanges.totalValue\"),\n    firstInstallment: getVal(\"sc.A7.forms.iptsChanges.firstInstallment\"),\n    condoId: condoId,\n    createdAt: serverTimestamp(),\n  };\n\n  try {\n    const docRef = await addDoc(lotsRef, newLot);\n    await updateDoc(docRef, { docId: docRef.id });\n\n    console.log(\"‚úÖ Lote salvo com ID:\", docRef.id);\n\n    tools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"sc.a7.validationMessage\"],\n        value: [\n          userExists\n            ? \"üè† Lote vinculado ao propriet√°rio existente!\"\n            : \"üÜï Propriet√°rio e lote cadastrados com sucesso!\",\n        ],\n      },\n    });\n  } catch (error) {\n    console.error(\"‚ùå Erro ao salvar lote:\", error);\n    tools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"sc.a7.validationMessage\"],\n        value: [\"‚ùå Erro ao salvar os dados. Verifique o console.\"],\n      },\n    });\n    return;\n  }\n\n  // Limpa campos e fecha pain√©is\n  tools.functions.setVar({\n    args: \"\",\n    pass: { keyPath: [\"sc.A7.forms.iptsChanges\"], value: [\"\"] },\n  });\n\n  //close Form\ntools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"all.toggles.forms\"],\n        value: [\" \"],\n      },\n    });\n  tools.functions.setVar({\n    args: \"\",\n    pass: { keyPath: [\"all.toggles.sideRight\"], value: [false] },\n  });\n  tools.functions.setVar({\n    args: \"\",\n    pass: { keyPath: [\"sc.a7.validationMessage\"], value: [\"\"] },\n  });\n}\n","newValue":"async () => {\n  const requiredFields = [\n    { path: \"sc.A7.forms.iptsChanges.partnerName\", name: \"Nome do Propriet√°rio\" },\n    { path: \"sc.A7.forms.iptsChanges.partnerMail\", name: \"E-mail\" },\n    { path: \"sc.A7.forms.iptsChanges.lot\", name: \"Obra\" },\n    { path: \"sc.A7.forms.iptsChanges.area\", name: \"√Årea\" },\n    { path: \"sc.A7.forms.iptsChanges.totalValue\", name: \"Valor total da obra\" },\n    { path: \"sc.A7.forms.iptsChanges.firstInstallment\", name: \"Valor total da entrada\" },\n  ];\n\n  const getVal = (path) => {\n    const val = tools.getCtData(path);\n    if (Array.isArray(val)) return val[0] ?? \"\";\n    return val ?? \"\";\n  };\n\n  const emptyFields = requiredFields.filter((f) => {\n    const v = getVal(f.path);\n    return v === \"\" || v === null || v === undefined;\n  });\n\n  if (emptyFields.length > 0) {\n    tools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"sc.a7.validationMessage\"],\n        value: [\"Preencha os campos obrigat√≥rios.\"],\n      },\n    });\n    console.warn(\"Campos vazios:\", emptyFields.map((f) => f.name).join(\", \"));\n    return;\n  }\n\n  console.log(\"üíæ Iniciando salvamento no Firebase...\");\n\n  // Inicializa o Firebase se ainda n√£o estiver pronto\n  let fbInit = tools.getCtData(\"all.temp.fireInit\");\n  if (!fbInit) {\n    const { initializeApp, getApps } = await import(\"firebase/app\");\n    const cfg = tools.getCtData(\"all.temp.fireConfig\");\n    fbInit = getApps().length ? getApps()[0] : initializeApp(cfg);\n    tools.setData({ path: \"all.temp.fireInit\", value: fbInit });\n  }\n\n  const {\n    getFirestore,\n    collection,\n    doc,\n    setDoc,\n    addDoc,\n    updateDoc,\n    query,\n    where,\n    getDocs,\n    serverTimestamp,\n  } = await import(\"firebase/firestore\");\n\n  const db = getFirestore(fbInit);\n\n  // Pega dados do formul√°rio\n  const email = getVal(\"sc.A7.forms.iptsChanges.partnerMail\");\n  const name = getVal(\"sc.A7.forms.iptsChanges.partnerName\");\n  const condoId = getVal(\"sc.A7.forms.iptsChanges.condoData.docId\");\n\n  if (!condoId) {\n    tools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"sc.a7.validationMessage\"],\n        value: [\"‚ö†Ô∏è Selecione um condom√≠nio antes de salvar.\"],\n      },\n    });\n    console.warn(\"Condom√≠nio ausente.\");\n    return;\n  }\n\n  // Busca usu√°rio existente\n  const usersRef = collection(db, \"users\");\n  const q = query(usersRef, where(\"userEmail\", \"==\", email));\n  const querySnapshot = await getDocs(q);\n\n  let ownerId;\n  let userExists = false;\n\n  if (!querySnapshot.empty) {\n    userExists = true;\n    const userDoc = querySnapshot.docs[0];\n    ownerId = userDoc.id;\n    console.log(\"‚úÖ Usu√°rio existente encontrado:\", ownerId);\n  } else {\n    console.log(\"üÜï Criando novo usu√°rio...\");\n    const newUserRef = doc(collection(db, \"users\"));\n    ownerId = newUserRef.id;\n\n    await setDoc(newUserRef, {\n      docId: ownerId,\n      userEmail: email,\n      userName: name,\n      createdAt: serverTimestamp(),\n    });\n\n    console.log(\"‚úÖ Novo usu√°rio criado com docId:\", ownerId);\n  }\n\n  // Cria o lote vinculado ao propriet√°rio\n  const lotsRef = collection(db, \"lots\");\n  const newLot = {\n    owner: name,\n    userEmail: email,\n    ownerId: ownerId,\n    lot: getVal(\"sc.A7.forms.iptsChanges.lot\"),\n    area: getVal(\"sc.A7.forms.iptsChanges.area\"),\n    totalValue: getVal(\"sc.A7.forms.iptsChanges.totalValue\"),\n    firstInstallment: getVal(\"sc.A7.forms.iptsChanges.firstInstallment\"),\n    condoId: condoId,\n    createdAt: serverTimestamp(),\n  };\n\n  try {\n    const docRef = await addDoc(lotsRef, newLot);\n    await updateDoc(docRef, { docId: docRef.id });\n\n    console.log(\"‚úÖ Lote salvo com ID:\", docRef.id);\n\n    tools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"sc.a7.validationMessage\"],\n        value: [\n          userExists\n            ? \"üè† Lote vinculado ao propriet√°rio existente!\"\n            : \"üÜï Propriet√°rio e lote cadastrados com sucesso!\",\n        ],\n      },\n    });\n  } catch (error) {\n    console.error(\"‚ùå Erro ao salvar lote:\", error);\n    tools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"sc.a7.validationMessage\"],\n        value: [\"‚ùå Erro ao salvar os dados. Verifique o console.\"],\n      },\n    });\n    return;\n  }\n\n  // Limpa campos e fecha pain√©is\n  tools.functions.setVar({\n    args: \"\",\n    pass: { keyPath: [\"sc.A7.forms.iptsChanges\"], value: [\"\"] },\n  });\n\n  //close Form\ntools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"all.toggles.forms\"],\n        value: [\" \"],\n      },\n    });\n\n  tools.functions.setVar({\n    args: \"\",\n    pass: { keyPath: [\"all.toggles.sideRight\"], value: [false] },\n  });\n  tools.functions.setVar({\n    args: \"\",\n    pass: { keyPath: [\"sc.a7.validationMessage\"], value: [\"\"] },\n  });\n}\n"}}