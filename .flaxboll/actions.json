{"1763561725921":{"actionType":"saveAll","createdAt":"1763561725921","actionID":"1763561725921","userID":"#TEMP","path":"system.capsules.3757bc92-00a4-4393-a217-cd330440d3b5.capsUseCodeInfo.capsUseInputs.sss_custom_caps-0.capsIptTxtValue","oldValue":"async () => {\n  const css1 =\n    \"color: limegreen; background-color: darkcyan; font-size: 11px; padding: 2px 6px; border-radius: 3px\";\n\n  try {\n    const { getFirestore, doc, updateDoc } = await import(\"firebase/firestore\");\n    const fbInit = tools.getCtData(\"all.temp.fireInit\");\n    const db = getFirestore(fbInit);\n\n    const lotId = tools.getCtData(\"sc.A10.currents.currId1\");\n    const form = tools.getCtData(\"sc.A10.forms.editChanges\");\n    const data = tools.getCtData(\"sc.A9.currents.currLoteData\");\n\n    console.log(\"Dados do Lote\", { lotId, form, data });\n\n    if (!lotId) {\n      console.warn(\"Nenhum lote selecionado (lotId ausente)\");\n      return;\n    }\n\n    // -------------------------\n    // Normaliza莽茫o dos campos\n    // -------------------------\n    const rawValue = (form?.value || \"\").trim();\n    const date = (form?.date || \"\").trim();\n    const description = (form?.installmentDescription || \"\").trim();\n    console.log(\"Campos normalizados:\", { rawValue, date, description });\n    const value = rawValue;\n\n    // -------------------------\n    // Hist贸rico do lote\n    // -------------------------\n    const existingInstallments = data?.installments || {};\n\n    //  Encontra o PRXIMO ID LIVRE: i1, i2, i3, i4...\n    let nextIndex = 1;\n    while (existingInstallments[\"i\" + nextIndex]) {\n      nextIndex++;\n    }\n    const newInstallmentId = \"i\" + nextIndex;\n\n    // -------------------------\n    // Nova parcela\n    // -------------------------\n    const newInstallment = {\n      installmentId: newInstallmentId,\n      date,\n      description,\n      value: value,\n    };\n    console.log(\"Nova parcela criada:\", { newInstallmentId, newInstallment });\n\n    // -------------------------\n    // Atualiza hist贸rico (mant茅m tudo + nova)\n    // -------------------------\n    const updatedInstallments = {\n      ...existingInstallments,\n      [newInstallmentId]: newInstallment,\n    };\n\n    console.log(\"Hist贸rico atualizado:\", { updatedInstallments });\n\n    // Reconta total de parcelas com base nas chaves iN\n    const allKeys = Object.keys(updatedInstallments).filter((k) =>\n      /^i\\d+$/.test(k)\n    );\n\n    // -------------------------\n    // Salvar no Firestore\n    // -------------------------\n    const dataToUpdate = {\n      installments: updatedInstallments,\n    };\n\n    console.log(\"Dados a atualizar no Firestore:\", { dataToUpdate });\n\n    const refDoc = doc(db, \"lots\", lotId);\n    await updateDoc(refDoc, dataToUpdate);\n\n    console.log(\"%c[OK] Parcela adicionada:\", css1, {\n      newInstallment,\n      dataToUpdate,\n    });\n\n    // Opcional: atualizar o currLoteData local para j谩 refletir na UI\n    tools.setData({\n      path: \"sc.A9.currents.currLoteData\",\n      value: {\n        ...(data || {}),\n        ...dataToUpdate,\n      },\n    });\n\n    // -------------------------\n    // Reset da UI\n    // -------------------------\n    tools.setData({ path: \"sc.A10.forms.editChanges\", value: {} });\n    tools.setData({ path: \"all.toggles.sideRight\", value: false });\n    tools.setData({ path: \"all.toggles.a10.addFinance\", value: false });\n\n    tools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"sc.A10.feedbackMessage\"],\n        value: [\"Parcela adicionada com sucesso!\"],\n      },\n    });\n  } catch (err) {\n    console.error(\"Erro ao salvar no Firebase:\", err);\n    tools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"sc.A10.feedbackMessage\"],\n        value: [\"Erro ao salvar. Verifique o console.\"],\n      },\n    });\n  }\n}","newValue":"async () => {\n  const css1 =\n    \"color: limegreen; background-color: darkcyan; font-size: 11px; padding: 2px 6px; border-radius: 3px\";\n\n  try {\n    const { getFirestore, doc, updateDoc } = await import(\"firebase/firestore\");\n    const fbInit = tools.getCtData(\"all.temp.fireInit\");\n    const db = getFirestore(fbInit);\n\n    const lotId = tools.getCtData(\"sc.A10.currents.currId1\");\n    const form = tools.getCtData(\"sc.A10.forms.editChanges\");\n    const data = tools.getCtData(\"sc.A9.currents.currLoteData\");\n\n    console.log(\"Dados do Lote\", { lotId, form, data });\n\n    if (!lotId) {\n      console.warn(\"Nenhum lote selecionado (lotId ausente)\");\n      return;\n    }\n\n    // -------------------------\n    // Normaliza莽茫o dos campos\n    // -------------------------\n    const rawValue = (form?.value || \"\").trim();\n    const date = (form?.date || \"\").trim();\n    const description = (form?.installmentDescription || \"\").trim();\n    console.log(\"Campos normalizados:\", { rawValue, date, description });\n    const value = rawValue;\n\n    // -------------------------\n    // Hist贸rico do lote\n    // -------------------------\n    const existingInstallments = data?.installments || {};\n\n    //  Encontra o PRXIMO ID LIVRE: i1, i2, i3, i4...\n    let nextIndex = 1;\n    while (existingInstallments[\"i\" + nextIndex]) {\n      nextIndex++;\n    }\n    const newInstallmentId = \"i\" + nextIndex;\n\n    // -------------------------\n    // Nova parcela\n    // -------------------------\n    const newInstallment = {\n      installmentId: newInstallmentId,\n      date,\n      description,\n      value: value,\n    };\n    console.log(\"Nova parcela criada:\", { newInstallmentId, newInstallment });\n\n    // -------------------------\n    // Atualiza hist贸rico (mant茅m tudo + nova)\n    // -------------------------\n    const updatedInstallments = {\n      ...existingInstallments,\n      [newInstallmentId]: newInstallment,\n    };\n\n    console.log(\"Hist贸rico atualizado:\", { updatedInstallments });\n\n    // Reconta total de parcelas com base nas chaves iN\n    const allKeys = Object.keys(updatedInstallments).filter((k) =>\n      /^i\\d+$/.test(k)\n    );\n\n    // -------------------------\n    // Salvar no Firestore\n    // -------------------------\n    const dataToUpdate = {\n      installments: updatedInstallments,\n    };\n\n    console.log(\"Dados a atualizar no Firestore:\", { dataToUpdate });\n\n    const refDoc = doc(db, \"lots\", lotId);\n    await updateDoc(refDoc, dataToUpdate);\n\n    console.log(\"%c[OK] Parcela adicionada:\", css1, {\n      newInstallment,\n      dataToUpdate,\n    });\n\n    // Opcional: atualizar o currLoteData local para j谩 refletir na UI\n    tools.setData({\n      path: \"sc.A9.currents.currLoteData\",\n      value: {\n        ...(data || {}),\n        ...dataToUpdate,\n      },\n    });\n\n    // -------------------------\n    // Reset da UI\n    // -------------------------\n    tools.setData({ path: \"sc.A10.forms.editChanges\", value: {} });\n    tools.setData({ path: \"all.toggles.sideRight\", value: false });\n   //close Form\ntools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"all.toggles.forms\"],\n        value: [\" \"],\n      },\n    });\n\n    tools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"sc.A10.feedbackMessage\"],\n        value: [\"Parcela adicionada com sucesso!\"],\n      },\n    });\n  } catch (err) {\n    console.error(\"Erro ao salvar no Firebase:\", err);\n    tools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"sc.A10.feedbackMessage\"],\n        value: [\"Erro ao salvar. Verifique o console.\"],\n      },\n    });\n  }\n}"}}