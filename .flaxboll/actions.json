{"1767195937292":{"actionType":"saveAll","createdAt":"1767195937292","actionID":"1767195937292","userID":"#TEMP","path":"system.capsules.eb213db5-0f6c-450a-ad29-d0e94e179e25.capsUseCodeInfo.capsUseInputs.sss_custom_caps-0.capsIptTxtValue","oldValue":"(args) => {\n  const css1 =\n    \"color: limegreen; background-color: darkcyan; font-size: 11px; padding: 2px 6px; border-radius: 3px\";\n\n  const item = tools.findFlatItem(args);\n  const stepsList = tools.getCtData(\"sc.A13.lists.list1\");\n  const staticList = tools.getCtData(\"sc.B7.statics.steps\");\n  const stepIdRaw = item?.stepId;\n\n  // ---- Guards\n  if (!item || stepIdRaw == null) {\n    console.warn(\"Step handler: item ou stepId ausente.\", { item });\n    return;\n  }\n\n  const stepId = String(stepIdRaw);\n  const pathSideRight = \"all.toggles.sideRight\";\n  const pathEdit = \"all.toggles.A14.editSteps\";\n\n  // Abre painel lateral (comum)\n  tools.setData({ path: pathSideRight, value: true });\n\n  // Procura match por stepId\n  const matched = Array.isArray(stepsList)\n    ? stepsList.find((d: any) => String(d?.stepId) === stepId)\n    : undefined;\n\n  const condMatch = Boolean(matched);\n  const currId = matched?.docId;\n\n  console.log({ item, stepsList, matched, condMatch, staticList });\n\n  function findStepById(arr, stepId) {\n    if (!Array.isArray(arr) || !stepId) return null;\n\n    for (const group of arr) {\n      if (!group?.subs) continue;\n\n      const found = group.subs.find((s) => s.stepId === stepId);\n      if (found) return { stepLabel: group.label, subStepLabel: found.label };\n    }\n\n    return null;\n  }\n  const selectStepStatic = findStepById(staticList, stepId);\n\n  // ---- Modo Editar\n  console.log(\"%cEdit Step Mode - \" + pathEdit, css1);\n\n  tools.setData({ path: pathEdit, value: true });\n\n  // Define os valores base no formulário de edição\n  tools.setData({\n    path: \"sc.A14.forms.editChanges\",\n    value: matched, // ✅ Passa todos os dados do documento\n  });\n\n  // Campos específicos importantes\n  tools.setData({ path: \"sc.A14.forms.editChanges.docId\", value: currId ?? \"\" });\n  tools.setData({ path: \"sc.A14.forms.editChanges.stepId\", value: stepId });\n\n  // Set CtData\n  tools.setData({\n    path: \"sc.A14.forms.viewChanges.stepLabel\",\n    value: selectStepStatic?.stepLabel ?? \"\",\n  });\n\n  tools.setData({\n    path: \"sc.A14.forms.viewChanges.subStepLabel\",\n    value: selectStepStatic?.subStepLabel ?? \"\",\n  });\n}","newValue":"async (args) => {\n  const css1 =\n    \"color: limegreen; background-color: darkcyan; font-size: 11px; padding: 2px 6px; border-radius: 3px\";\n\n  const currLot = tools.getCtData(\"sc.A7.currents.allLot\");\n  const item = tools.findFlatItem(args);\n  const stepsList = tools.getCtData(\"sc.A13.lists.list1\");\n  const staticList = tools.getCtData(\"sc.B7.statics.steps\");\n  const stepIdRaw = item?.stepId;\n\n  // ---- Guards\n  if (!item || stepIdRaw == null) {\n    console.warn(\"Step handler: item ou stepId ausente.\", { item });\n    return;\n  }\n\n  const stepId = String(stepIdRaw);\n  const pathSideRight = \"all.toggles.sideRight\";\n  const pathEdit = \"all.toggles.A14.editSteps\";\n\n  // Abre painel lateral (comum)\n  tools.setData({ path: pathSideRight, value: true });\n\n  // Procura match por stepId\n  const matched = Array.isArray(stepsList)\n    ? stepsList.find((d: any) => String(d?.stepId) === stepId)\n    : undefined;\n\n  const condMatch = Boolean(matched);\n  const currId = matched?.docId;\n\n  console.log({ item, stepsList, matched, condMatch, staticList });\n\n  function findStepById(arr, stepId) {\n    if (!Array.isArray(arr) || !stepId) return null;\n\n    for (const group of arr) {\n      if (!group?.subs) continue;\n\n      const found = group.subs.find((s) => s.stepId === stepId);\n      if (found) return { stepLabel: group.label, subStepLabel: found.label };\n    }\n\n    return null;\n  }\n  const selectStepStatic = findStepById(staticList, stepId);\n\n  // --- Update Firebase Lot Step Read Alert\n  const lotId = currLot?.docId;\n  console.log({ currLot, lotId });\n\n  // ------ set Lot Notifications\n  if (lotId && lotId !== \"\") {\n    const { getFirestore, doc, updateDoc } = await import(\"firebase/firestore\");\n    const fbInit = tools.getCtData(\"all.temp.fireInit\");\n    const db = getFirestore(fbInit);\n    const refDocLot = doc(db, \"lots\", lotId);\n    const newId = stepId.replace(\".\", \"_\"); // substitui pontos por underline\n\n    const lotDataToUpdate = {\n      [\"readSteps.\" + newId]: false,\n    };\n\n    await updateDoc(refDocLot, lotDataToUpdate);\n  }\n\n  // ---- Modo Editar\n  console.log(\"%cEdit Step Mode - \" + pathEdit, css1);\n\n  tools.setData({ path: pathEdit, value: true });\n\n  // Define os valores base no formulário de edição\n  tools.setData({\n    path: \"sc.A14.forms.editChanges\",\n    value: matched, // ✅ Passa todos os dados do documento\n  });\n\n  // Campos específicos importantes\n  tools.setData({\n    path: \"sc.A14.forms.editChanges.docId\",\n    value: currId ?? \"\",\n  });\n  tools.setData({ path: \"sc.A14.forms.editChanges.stepId\", value: stepId });\n\n  // Set CtData\n  tools.setData({\n    path: \"sc.A14.forms.viewChanges.stepLabel\",\n    value: selectStepStatic?.stepLabel ?? \"\",\n  });\n\n  tools.setData({\n    path: \"sc.A14.forms.viewChanges.subStepLabel\",\n    value: selectStepStatic?.subStepLabel ?? \"\",\n  });\n}"}}