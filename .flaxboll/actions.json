{"1764621574394":{"actionType":"saveAll","createdAt":"1764621574394","actionID":"1764621574394","userID":"#TEMP","path":"system.capsules.3757bc92-00a4-4393-a217-cd330440d3b5.capsUseCodeInfo.capsUseInputs.sss_custom_caps-0.capsIptTxtValue","oldValue":"async () => {\n  const css1 =\n    \"color: limegreen; background-color: darkcyan; font-size: 11px; padding: 2px 6px; border-radius: 3px\";\n\n  try {\n    const { getFirestore, doc, updateDoc } = await import(\"firebase/firestore\");\n    const fbInit = tools.getCtData(\"all.temp.fireInit\");\n    const db = getFirestore(fbInit);\n\n    const lotId = tools.getCtData(\"sc.A10.currents.currId1\");\n    const form = tools.getCtData(\"sc.A10.forms.editChanges\");\n    const data = tools.getCtData(\"sc.A9.currents.currLoteData\");\n\n    console.log(\"Dados do Lote\", { lotId, form, data });\n\n    if (!lotId) {\n      console.warn(\"Nenhum lote selecionado (lotId ausente)\");\n      return;\n    }\n\n    // -------------------------\n\t\t// Normaliza칞칚o dos campos\n\t\t// -------------------------\nconst rawValue = (form?.value || \"\").trim();\nconst date = (form?.date || \"\").trim();\nconst description = (form?.installmentDescription || \"\").trim();\nconst value = rawValue;\n\nconsole.log(\"Campos normalizados:\", { rawValue, date, description });\n\n\t\t// -------------------------\n\t\t// Valida칞칚o de campos obrigat칩rios\n\t\t// -------------------------\nif (!value || !date || !description) {\n  tools.functions.setVar({\n    args: \"\",\n    pass: {\n      keyPath: [\"sc.A10.feedbackMessage\"],\n      value: [\"Preencha todos os campos obrigat칩rios.\"],\n    },\n  });\n\n// estado = erro (COR VERMELHA)\n    tools.setData({\n  path: \"sc.A10.validationColor\",\n  value: \"red\",\n});\n\n  console.warn(\"丘멆잺 Campos vazios detectados:\", {\n    value,\n    date,\n    description,\n  });\n\n  return; // Interrompe o fluxo\n}\n\n// estado = sucesso (COR VERDE)\ntools.setData({\n  path: \"sc.A10.validationColor\",\n  value: \"green\",\n});\n\n    // -------------------------\n    // Hist칩rico do lote\n    // -------------------------\n    const existingInstallments = data?.installments || {};\n\n    // 游댳 Encontra o PR칍XIMO ID LIVRE: i1, i2, i3, i4...\n    let nextIndex = 1;\n    while (existingInstallments[\"i\" + nextIndex]) {\n      nextIndex++;\n    }\n    const newInstallmentId = \"i\" + nextIndex;\n\n    // -------------------------\n    // Nova parcela\n    // -------------------------\n    const newInstallment = {\n      installmentId: newInstallmentId,\n      date,\n      description,\n      value: value,\n    };\n    console.log(\"Nova parcela criada:\", { newInstallmentId, newInstallment });\n\n    // -------------------------\n    // Atualiza hist칩rico (mant칠m tudo + nova)\n    // -------------------------\n    const updatedInstallments = {\n      ...existingInstallments,\n      [newInstallmentId]: newInstallment,\n    };\n\n    console.log(\"Hist칩rico atualizado:\", { updatedInstallments });\n\n    // Reconta total de parcelas com base nas chaves iN\n    const allKeys = Object.keys(updatedInstallments).filter((k) =>\n      /^i\\d+$/.test(k)\n    );\n\n    // -------------------------\n    // Salvar no Firestore\n    // -------------------------\n    const dataToUpdate = {\n      installments: updatedInstallments,\n    };\n\n    console.log(\"Dados a atualizar no Firestore:\", { dataToUpdate });\n\n    const refDoc = doc(db, \"lots\", lotId);\n    await updateDoc(refDoc, dataToUpdate);\n\n    console.log(\"%c[OK] Parcela adicionada:\", css1, {\n      newInstallment,\n      dataToUpdate,\n    });\n\n    // Opcional: atualizar o currLoteData local para j치 refletir na UI\n    tools.setData({\n      path: \"sc.A9.currents.currLoteData\",\n      value: {\n        ...(data || {}),\n        ...dataToUpdate,\n      },\n    });\n\n    // -------------------------\n    // Reset da UI\n    // -------------------------\n    tools.setData({ path: \"sc.A10.forms.editChanges\", value: {} });\n    tools.setData({ path: \"all.toggles.sideRight\", value: false });\n   //close Form\ntools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"all.toggles.forms\"],\n        value: [\" \"],\n      },\n    });\n\n    tools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"sc.A10.feedbackMessage\"],\n        value: [\"Parcela adicionada com sucesso!\"],\n      },\n    });\n\ttools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"sc.A10.feedbackMessage\"],\n        value: [\" \"],\n      },\n    });\n  } catch (err) {\n    console.error(\"Erro ao salvar no Firebase:\", err);\n    tools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"sc.A10.feedbackMessage\"],\n        value: [\"Erro ao salvar. Verifique o console.\"],\n      },\n    });\n  }\n}","newValue":"async () => {\n  const css1 =\n    \"color: limegreen; background-color: darkcyan; font-size: 11px; padding: 2px 6px; border-radius: 3px\";\n\n  try {\n    const { getFirestore, doc, updateDoc } = await import(\"firebase/firestore\");\n    const fbInit = tools.getCtData(\"all.temp.fireInit\");\n    const db = getFirestore(fbInit);\n\n    const lotId = tools.getCtData(\"sc.A10.currents.currId1\");\n    const form = tools.getCtData(\"sc.A10.forms.editChanges\");\n    const data = tools.getCtData(\"sc.A9.currents.currLoteData\");\n\n    console.log(\"Dados do Lote\", { lotId, form, data });\n\n    if (!lotId) {\n      console.warn(\"Nenhum lote selecionado (lotId ausente)\");\n      return;\n    }\n\n    // -------------------------\n\t\t// Normaliza칞칚o dos campos\n\t\t// -------------------------\nconst rawValue = (form?.value || \"\").trim();\nconst date = (form?.date || \"\").trim();\nconst description = (form?.installmentDescription || \"\").trim();\nconst value = rawValue;\n\nconsole.log(\"Campos normalizados:\", { rawValue, date, description });\n\n\t\t// -------------------------\n\t\t// Valida칞칚o de campos obrigat칩rios\n\t\t// -------------------------\nif (!value || !date || !description) {\n  tools.functions.setVar({\n    args: \"\",\n    pass: {\n      keyPath: [\"sc.A10.feedbackMessage\"],\n      value: [\"Preencha todos os campos obrigat칩rios.\"],\n    },\n  });\n\n// estado = erro (COR VERMELHA)\n    tools.setData({\n  path: \"sc.A10.validationColor\",\n  value: \"red\",\n});\n\n  console.warn(\"丘멆잺 Campos vazios detectados:\", {\n    value,\n    date,\n    description,\n  });\n\n  return; // Interrompe o fluxo\n}\n\n// estado = sucesso (COR VERDE)\ntools.setData({\n  path: \"sc.A10.validationColor\",\n  value: \"green\",\n});\n\n    // -------------------------\n    // Hist칩rico do lote\n    // -------------------------\n    const existingInstallments = data?.installments || {};\n\n    // 游댳 Encontra o PR칍XIMO ID LIVRE: i1, i2, i3, i4...\n    let nextIndex = 1;\n    while (existingInstallments[\"i\" + nextIndex]) {\n      nextIndex++;\n    }\n    const newInstallmentId = \"i\" + nextIndex;\n\n    // -------------------------\n    // Nova parcela\n    // -------------------------\n    const newInstallment = {\n      installmentId: newInstallmentId,\n      date,\n      description,\n      value: value,\n    };\n    console.log(\"Nova parcela criada:\", { newInstallmentId, newInstallment });\n\n    // -------------------------\n    // Atualiza hist칩rico (mant칠m tudo + nova)\n    // -------------------------\n    const updatedInstallments = {\n      ...existingInstallments,\n      [newInstallmentId]: newInstallment,\n    };\n\n    console.log(\"Hist칩rico atualizado:\", { updatedInstallments });\n\n    // Reconta total de parcelas com base nas chaves iN\n    const allKeys = Object.keys(updatedInstallments).filter((k) =>\n      /^i\\d+$/.test(k)\n    );\n\n    // -------------------------\n    // Salvar no Firestore\n    // -------------------------\n    const dataToUpdate = {\n      installments: updatedInstallments,\n    };\n\n    console.log(\"Dados a atualizar no Firestore:\", { dataToUpdate });\n\n    const refDoc = doc(db, \"lots\", lotId);\n    await updateDoc(refDoc, dataToUpdate);\n\n    console.log(\"%c[OK] Parcela adicionada:\", css1, {\n      newInstallment,\n      dataToUpdate,\n    });\n\n    // Opcional: atualizar o currLoteData local para j치 refletir na UI\n    tools.setData({\n      path: \"sc.A9.currents.currLoteData\",\n      value: {\n        ...(data || {}),\n        ...dataToUpdate,\n      },\n    });\n\n    // -------------------------\n    // Reset da UI\n    // -------------------------\n    tools.setData({ path: \"sc.A10.forms.editChanges\", value: {} });\n    tools.setData({ path: \"all.toggles.sideRight\", value: false });\n   //close Form\ntools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"all.toggles.forms\"],\n        value: [\" \"],\n      },\n    });\n\n    tools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"sc.A10.feedbackMessage\"],\n        value: [\"Parcela adicionada com sucesso!\"],\n      },\n    });\n\t\ttools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"sc.A10.feedbackMessage\"],\n        value: [\" \"],\n      },\n    });\n  } catch (err) {\n    console.error(\"Erro ao salvar no Firebase:\", err);\n    tools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"sc.A10.feedbackMessage\"],\n        value: [\"Erro ao salvar. Verifique o console.\"],\n      },\n    });\n  }\n}"}}