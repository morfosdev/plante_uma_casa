{"1765379929864":{"actionType":"saveAll","createdAt":"1765379929864","actionID":"1765379929864","userID":"#TEMP","path":"system.capsules.7d48ab0a-bf32-4fe2-99c6-bc478137fba3.capsUseCodeInfo.capsUseInputs.sss_freeValue-0.capsIptTxtValue","oldValue":"\nimport JSON5 from \"json5\";\nimport React from \"react\";\nimport * as RN from \"react-native\";\n\n// ---------- import Packs\nimport * as Google from \"expo-auth-session/providers/google\";\nimport * as WebBrowser from \"expo-web-browser\";\nimport { getApps, initializeApp, type FirebaseApp } from \"firebase/app\";\nimport {\n  getAuth,\n  GoogleAuthProvider,\n  signInWithCredential,\n  signInWithPopup,\n  signInWithRedirect,\n  type Auth,\n} from \"firebase/auth\";\nimport { useData } from \"../../..\";\n\n// Finaliza sessoes pendentes (necessario para Web/Expo)\nWebBrowser.maybeCompleteAuthSession();\n\ntype TLoginFunc = (data: any, args?: any) => any;\n\ntype TLoginConfigs = {\n  btnStyle?: RN.StyleProp<RN.ViewStyle>;\n  txtStyle?: RN.StyleProp<RN.TextStyle>;\n  txtLabel?: string;\n};\n\ntype TLoginPass = {\n  arrFuncs?: TLoginFunc[];\n  configs?: TLoginConfigs | string | any[];\n  args?: any;\n};\n\ntype TProps = {\n  pass?: TLoginPass;\n};\n\n// ---------- IDs do Google OAuth por plataforma (preencha!)\nconst IOS_CLIENT_ID = \"\";\nconst ANDROID_CLIENT_ID =\n  \"1099098264007-thb39j1g2ilg74mvrquruu01iaifj9e1.apps.googleusercontent.com\";\n\nconst getFirebaseApp = (): FirebaseApp | null => {\n  const state = useData.getState();\n  const rawInit = state?.all?.temp?.fireInit ?? state?.all?.fireInit;\n  const appFromState = Array.isArray(rawInit) ? rawInit[0] : rawInit;\n  if (appFromState) return appFromState;\n\n  const rawConfig = state?.all?.temp?.fireConfig ?? state?.all?.fireConfig;\n  if (!rawConfig) return null;\n\n  const already = getApps();\n  if (already.length) return already[0];\n\n  return initializeApp(rawConfig);\n};\n\nconst normalizeConfigs = (rawConfigs: TLoginPass[\"configs\"]): TLoginConfigs => {\n  let parsed: any = rawConfigs;\n\n  if (Array.isArray(parsed)) parsed = parsed[0];\n\n  if (typeof parsed === \"string\") {\n    try {\n      parsed = JSON5.parse(parsed.trim());\n    } catch (err) {\n      console.warn(\"[LoginWeb] configs parse error:\", err);\n      parsed = {};\n    }\n  }\n\n  return parsed && typeof parsed === \"object\" && !Array.isArray(parsed)\n    ? parsed\n    : {};\n};\n\n// =========================================\n// Componente: Login para Nativo (Android/iOS)\n// =========================================\nexport const LoginNative = (_props: { pass?: TLoginPass }) => {\n  const [loading, setLoading] = React.useState(false);\n  const pass = _props?.pass ?? {};\n\n  // Somente Android nativo\n  const [request, response, promptAsync] = Google.useIdTokenAuthRequest({\n    androidClientId: ANDROID_CLIENT_ID,\n    selectAccount: true,\n  });\n\n  React.useEffect(() => {\n    const run = async () => {\n      if (!response) return;\n\n      setLoading(false);\n\n      if (response.type === \"success\") {\n        try {\n          const idToken = response.params?.id_token;\n          console.log(\"[LoginAndroid] id_token:\", idToken);\n\n          const fbApp = getFirebaseApp();\n          if (!fbApp) {\n            console.error(\"[LoginAndroid] Firebase app não encontrado.\");\n            return;\n          }\n\n          const auth = getAuth(fbApp);\n\n          const credential = GoogleAuthProvider.credential(idToken);\n\n          const result = await signInWithCredential(auth, credential);\n          console.log(\"[LoginAndroid] Firebase user:\", result.user);\n\n          // salva no banco\n          const dbResult = await setUserDB(result.user, auth);\n          if (dbResult.status !== \"success\") {\n            throw new Error(dbResult.message);\n          }\n\n          // executa callbacks\n          const arrFuncs = Array.isArray(pass.arrFuncs) ? pass.arrFuncs : [];\n          for (const currFunc of arrFuncs) await currFunc(dbResult.data);\n        } catch (err) {\n          console.error(\"[LoginAndroid] login error:\", err);\n        }\n      }\n\n      if (response.type === \"error\") {\n        console.error(\"[LoginAndroid] error:\", (response as any).error);\n      }\n    };\n\n    run();\n  }, [response]);\n\n  const handlePress = async () => {\n    try {\n      setLoading(true);\n      // Nativo: sem proxy\n      await promptAsync();\n    } catch (err) {\n      setLoading(false);\n      console.error(\"[LoginAndroid] promptAsync error:\", err);\n    }\n  };\n\n  return (\n    <RN.View style={{ alignItems: \"center\" }}>\n      <RN.Pressable\n        onPress={handlePress}\n        disabled={!request || loading}\n        style={{\n          backgroundColor: \"#315e2d\",\n          paddingHorizontal: 20,\n          height: 44,\n          borderRadius: 999,\n          alignItems: \"center\",\n          justifyContent: \"center\",\n          opacity: !request || loading ? 0.7 : 1,\n        }}\n      >\n        <RN.Text style={{ color: \"#fff\", fontWeight: \"700\" }}>\n          {loading ? \"Conectando...\" : \"Entrar com Google\"}\n        </RN.Text>\n      </RN.Pressable>\n\n      {loading ? <RN.ActivityIndicator style={{ marginTop: 8 }} /> : null}\n    </RN.View>\n  );\n};\n\n// =========================================\n// Componente: Login para Web\n// =========================================\nconst LoginWeb = (props: { pass?: TLoginPass }) => {\n  console.log(\"Comp Login WEB\", { props });\n  const pass = props?.pass ?? {};\n  const args = pass.args;\n  const arrFuncs = Array.isArray(pass.arrFuncs) ? pass.arrFuncs : [];\n  const configs = normalizeConfigs(pass.configs);\n  console.log(\"Comp Login WEB\", { configs });\n\n  // Renderiza apenas no Web\n  if (RN.Platform.OS !== \"web\") return null;\n\n  const [loading, setLoading] = React.useState(false);\n\n  const handleLogin = async () => {\n    try {\n      setLoading(true);\n\n      const fbApp = getFirebaseApp();\n      if (!fbApp)\n        throw new Error(\"Firebase config nao encontrado para inicializar.\");\n\n      const auth = getAuth(fbApp);\n      const provider = new GoogleAuthProvider();\n      provider.setCustomParameters({ prompt: \"select_account\" });\n\n      let result;\n\n      try {\n        // 1) Tenta popup\n        result = await signInWithPopup(auth, provider);\n      } catch (popupErr: any) {\n        console.warn(\"[LoginWeb] erro no popup:\", popupErr?.code, popupErr);\n\n        // Só cai para redirect se for erro tipico de popup\n        const code = popupErr?.code as string | undefined;\n        const popupIssues = [\n          \"auth/popup-blocked\",\n          \"auth/popup-closed-by-user\",\n          \"auth/cancelled-popup-request\",\n        ];\n\n        if (code && popupIssues.includes(code)) {\n          console.log(\"[LoginWeb] tentando fluxo de redirect...\");\n          await signInWithRedirect(auth, provider);\n          return; // o resto sera tratado no useEffect (getRedirectResult)\n        }\n\n        // Se for outro erro → propaga\n        throw popupErr;\n      }\n\n      // Se chegou aqui, popup funcionou\n      if (!result?.user) {\n        throw new Error(\"Resultado do login (popup) sem user.\");\n      }\n\n      const dbResult = await setUserDB(result.user, auth);\n      if (dbResult.status !== \"success\") {\n        throw new Error(\n          dbResult.message ?? \"Falha ao salvar usuario no banco.\"\n        );\n      }\n\n      for (const currFunc of arrFuncs) await currFunc(dbResult.data, args);\n    } catch (err) {\n      console.error(\"Erro no login Google (web):\", err);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const defaultBtnStyle = {\n    paddingVertical: 12,\n    paddingHorizontal: 16,\n    borderRadius: 8,\n    borderWidth: 1,\n    borderColor: \"#ccc\",\n    alignItems: \"center\",\n    justifyContent: \"center\",\n    backgroundColor: \"#fff\",\n  };\n\n  const defaultTxtStyle = {\n    fontWeight: \"bold\",\n  };\n\n  const customBtnStyles =\n    configs?.btnStyle && Object.keys(configs.btnStyle).length > 0\n      ? configs.btnStyle\n      : null;\n\n  const customTxtStyles =\n    configs?.txtStyle && Object.keys(configs.txtStyle).length > 0\n      ? configs.txtStyle\n      : null;\n\n  console.log(\"Comp Login WEB\", { customBtnStyles });\n\n  const defaultTxt = \"Entrar com Google\";\n  const condText = configs?.txtLabel ?? defaultTxt;\n  return (\n    <RN.Pressable\n      onPress={handleLogin}\n      disabled={loading}\n      style={({ pressed }) => [\n        customBtnStyles ?? defaultBtnStyle,\n        { opacity: pressed || loading ? 0.6 : 1 },\n      ]}\n      accessibilityRole=\"button\"\n      accessibilityLabel=\"Entrar com conta Google (Web)\"\n    >\n      <RN.Text style={[customTxtStyles ?? defaultTxtStyle]}>\n        {loading ? \"Conectando...\" : condText}\n      </RN.Text>\n    </RN.Pressable>\n  );\n};\n\n// =========================================\n// Wrapper: decide por plataforma\n// =========================================\nexport const Login = (props: TProps) => {\n  if (RN.Platform.OS === \"web\") {\n    return <LoginWeb pass={props?.pass} />;\n  }\n  return <LoginNative pass={props?.pass} />;\n};\n\nconst setUserDB = async (user: any, authFromLogin?: Auth) => {\n  console.log(\"Início SetUserDB - Parametro recebido\", user);\n\n  // Importa Firestore e salva o documento\n  const { displayName, email, photoURL, uid } = user;\n  let userToSet: Record<string, any> = {};\n\n  const userData = {\n    userName: displayName,\n    userEmail: email,\n    userImage: photoURL,\n    docId: uid,\n  };\n\n  const {\n    getFirestore,\n    collection,\n    doc,\n    setDoc,\n    updateDoc,\n    serverTimestamp,\n    getDoc,\n    getDocs,\n    query,\n    where,\n  } = await import(\"firebase/firestore\");\n\n  const fbApp = authFromLogin?.app ?? getFirebaseApp();\n  if (!fbApp) {\n    return { status: \"error\", message: \"Firebase nao inicializado.\" };\n  }\n  const db = getFirestore(fbApp);\n\n  let lotId = null;\n  let condoId = null;\n\n  // ---- LOTS\n  const lotsCol = collection(db, \"lots\");\n  const q = query(lotsCol, where(\"userEmail\", \"==\", email));\n  const searchLot = await getDocs(q);\n\n  const lotExists = searchLot.docs.length > 0;\n  if (lotExists) {\n    const lotDoc = searchLot.docs[0];\n    const lotData = lotDoc.data();\n    console.log(\"Lote encontrado para o usuario:\", lotData);\n\n    lotId = lotDoc.id;\n    condoId = lotData.condoId;\n  } else {\n    console.log(\"Nenhum lote encontrado para o usuario.\");\n  }\n\n  // ---- PREREGISTERED USERS\n  // ---- BARRAR SE ADM NÃO ADICIONOU O USUÁRIO ANTES\n  const preRegCol = collection(db, \"preRegisteredUsers\");\n  const q2 = query(preRegCol, where(\"userEmail\", \"==\", email));\n  const searchPreReg = await getDocs(q2);\n  const preRegExists = searchPreReg.docs.length > 0;\n  \n  // SE pre-registrado existe, cria/atualiza user\n  if (preRegExists) {\n    const preRegDoc = searchPreReg.docs[0];\n    const preRegData = preRegDoc.data();\n    console.log(\"Pre-registrado encontrado para o usuario:\", preRegData);\n\n    // ---- USERS\n    const usersCol = collection(db, \"users\");\n    const userDocRef = doc(usersCol, uid);\n    const userDocSnap = await getDoc(userDocRef);\n    console.log(\"Xx userDocSnap:\", \"users\", uid);\n\n    const userExists = userDocSnap.exists();\n\n    console.log(\"Xx userDocSnap:\", userExists);\n\n    if (userExists) {\n      const fullRegister = userDocSnap.data().fullRegister;\n\n      userToSet = {\n        updatedAt: serverTimestamp(),\n        ...userData,\n\n        fullRegister,\n        condoId: condoId ?? null,\n        lotId: lotId ?? null,\n      };\n\n      // Atualiza documento existente\n      await updateDoc(userDocRef, userToSet);\n      console.log(\"Usuario atualizado no banco de dados.\");\n    }\n\n    if (!userExists) {\n      userToSet = {\n        createdAt: serverTimestamp(),\n        ...userData,\n\n        typeAccount: \"app\",\n        fullRegister: false,\n        condoId: condoId ?? null,\n        lotId: lotId ?? null,\n        steps: {},\n      };\n      console.log(\"Novo usuario adicionado ao banco de dados.\");\n      await setDoc(userDocRef, userToSet);\n    }\n\n    // Fallback\n    return { status: \"success\", data: userToSet };\n  } \n  else {\n    console.log(\"Nenhum pre-registrado encontrado para o usuario.\");\n\n    return {\n      status: \"error\",\n      data: null,\n      message: \"Usuario nao pre-registrado.\",\n    };\n  }\n};","newValue":"\n\nimport JSON5 from \"json5\";\nimport React from \"react\";\nimport * as RN from \"react-native\";\n\n// ---------- import Packs\nimport * as Google from \"expo-auth-session/providers/google\";\nimport * as WebBrowser from \"expo-web-browser\";\nimport { getApps, initializeApp, type FirebaseApp } from \"firebase/app\";\nimport {\n  getAuth,\n  GoogleAuthProvider,\n  signInWithCredential,\n  signInWithPopup,\n  signInWithRedirect,\n  type Auth,\n} from \"firebase/auth\";\nimport { useData } from \"../../..\";\n\n// Finaliza sessoes pendentes (necessario para Web/Expo)\nWebBrowser.maybeCompleteAuthSession();\n\ntype TLoginFunc = (data: any, args?: any) => any;\n\ntype TLoginConfigs = {\n  btnStyle?: RN.StyleProp<RN.ViewStyle>;\n  txtStyle?: RN.StyleProp<RN.TextStyle>;\n  txtLabel?: string;\n};\n\ntype TLoginPass = {\n  arrFuncs?: TLoginFunc[];\n  configs?: TLoginConfigs | string | any[];\n  args?: any;\n};\n\ntype TProps = {\n  pass?: TLoginPass;\n};\n\n// ---------- IDs do Google OAuth por plataforma (preencha!)\nconst IOS_CLIENT_ID = \"\";\nconst ANDROID_CLIENT_ID =\n  \"1099098264007-thb39j1g2ilg74mvrquruu01iaifj9e1.apps.googleusercontent.com\";\n\nconst getFirebaseApp = (): FirebaseApp | null => {\n  const state = useData.getState();\n  const rawInit = state?.all?.temp?.fireInit ?? state?.all?.fireInit;\n  const appFromState = Array.isArray(rawInit) ? rawInit[0] : rawInit;\n  if (appFromState) return appFromState;\n\n  const rawConfig = state?.all?.temp?.fireConfig ?? state?.all?.fireConfig;\n  if (!rawConfig) return null;\n\n  const already = getApps();\n  if (already.length) return already[0];\n\n  return initializeApp(rawConfig);\n};\n\nconst normalizeConfigs = (rawConfigs: TLoginPass[\"configs\"]): TLoginConfigs => {\n  let parsed: any = rawConfigs;\n\n  if (Array.isArray(parsed)) parsed = parsed[0];\n\n  if (typeof parsed === \"string\") {\n    try {\n      parsed = JSON5.parse(parsed.trim());\n    } catch (err) {\n      console.warn(\"[LoginWeb] configs parse error:\", err);\n      parsed = {};\n    }\n  }\n\n  return parsed && typeof parsed === \"object\" && !Array.isArray(parsed)\n    ? parsed\n    : {};\n};\n\n// =========================================\n// Componente: Login para Nativo (Android/iOS)\n// =========================================\nexport const LoginNative = (_props: { pass?: TLoginPass }) => {\n  const [loading, setLoading] = React.useState(false);\n  const pass = _props?.pass ?? {};\n\n  // Somente Android nativo\n  const [request, response, promptAsync] = Google.useIdTokenAuthRequest({\n    androidClientId: ANDROID_CLIENT_ID,\n    selectAccount: true,\n  });\n\n  React.useEffect(() => {\n    const run = async () => {\n      if (!response) return;\n\n      setLoading(false);\n\n      if (response.type === \"success\") {\n        try {\n          const idToken = response.params?.id_token;\n          console.log(\"[LoginAndroid] id_token:\", idToken);\n\n          const fbApp = getFirebaseApp();\n          if (!fbApp) {\n            console.error(\"[LoginAndroid] Firebase app não encontrado.\");\n            return;\n          }\n\n          const auth = getAuth(fbApp);\n\n          const credential = GoogleAuthProvider.credential(idToken);\n\n          const result = await signInWithCredential(auth, credential);\n          console.log(\"[LoginAndroid] Firebase user:\", result.user);\n\n          // salva no banco\n          const dbResult = await setUserDB(result.user, auth);\n          if (dbResult.status !== \"success\") {\n            throw new Error(dbResult.message);\n          }\n\n          // executa callbacks\n          const arrFuncs = Array.isArray(pass.arrFuncs) ? pass.arrFuncs : [];\n          for (const currFunc of arrFuncs) await currFunc(dbResult.data);\n        } catch (err) {\n          console.error(\"[LoginAndroid] login error:\", err);\n        }\n      }\n\n      if (response.type === \"error\") {\n        console.error(\"[LoginAndroid] error:\", (response as any).error);\n      }\n    };\n\n    run();\n  }, [response]);\n\n  const handlePress = async () => {\n    try {\n      setLoading(true);\n      // Nativo: sem proxy\n      await promptAsync();\n    } catch (err) {\n      setLoading(false);\n      console.error(\"[LoginAndroid] promptAsync error:\", err);\n    }\n  };\n\n  return (\n    <RN.View style={{ alignItems: \"center\" }}>\n      <RN.Pressable\n        onPress={handlePress}\n        disabled={!request || loading}\n        style={{\n          backgroundColor: \"#315e2d\",\n          paddingHorizontal: 20,\n          height: 44,\n          borderRadius: 999,\n          alignItems: \"center\",\n          justifyContent: \"center\",\n          opacity: !request || loading ? 0.7 : 1,\n        }}\n      >\n        <RN.Text style={{ color: \"#fff\", fontWeight: \"700\" }}>\n          {loading ? \"Conectando...\" : \"Entrar com Google\"}\n        </RN.Text>\n      </RN.Pressable>\n\n      {loading ? <RN.ActivityIndicator style={{ marginTop: 8 }} /> : null}\n    </RN.View>\n  );\n};\n\n// =========================================\n// Componente: Login para Web\n// =========================================\nconst LoginWeb = (props: { pass?: TLoginPass }) => {\n  console.log(\"Comp Login WEB\", { props });\n  const pass = props?.pass ?? {};\n  const args = pass.args;\n  const arrFuncs = Array.isArray(pass.arrFuncs) ? pass.arrFuncs : [];\n  const configs = normalizeConfigs(pass.configs);\n  console.log(\"Comp Login WEB\", { configs });\n\n  // Renderiza apenas no Web\n  if (RN.Platform.OS !== \"web\") return null;\n\n  const [loading, setLoading] = React.useState(false);\n\n  const handleLogin = async () => {\n    try {\n      setLoading(true);\n\n      const fbApp = getFirebaseApp();\n      if (!fbApp)\n        throw new Error(\"Firebase config nao encontrado para inicializar.\");\n\n      const auth = getAuth(fbApp);\n      const provider = new GoogleAuthProvider();\n      provider.setCustomParameters({ prompt: \"select_account\" });\n\n      let result;\n\n      try {\n        // 1) Tenta popup\n        result = await signInWithPopup(auth, provider);\n      } catch (popupErr: any) {\n        console.warn(\"[LoginWeb] erro no popup:\", popupErr?.code, popupErr);\n\n        // Só cai para redirect se for erro tipico de popup\n        const code = popupErr?.code as string | undefined;\n        const popupIssues = [\n          \"auth/popup-blocked\",\n          \"auth/popup-closed-by-user\",\n          \"auth/cancelled-popup-request\",\n        ];\n\n        if (code && popupIssues.includes(code)) {\n          console.log(\"[LoginWeb] tentando fluxo de redirect...\");\n          await signInWithRedirect(auth, provider);\n          return; // o resto sera tratado no useEffect (getRedirectResult)\n        }\n\n        // Se for outro erro → propaga\n        throw popupErr;\n      }\n\n      // Se chegou aqui, popup funcionou\n      if (!result?.user) {\n        throw new Error(\"Resultado do login (popup) sem user.\");\n      }\n\n      const dbResult = await setUserDB(result.user, auth);\n      if (dbResult.status !== \"success\") {\n        for (const currFunc of arrFuncs) await currFunc(dbResult, args);\n        throw new Error(\n          dbResult.message ?? \"Falha ao salvar usuario no banco.\"\n        );\n      }\n\n      for (const currFunc of arrFuncs) await currFunc(dbResult.data, args);\n    } catch (err) {\n      console.error(\"Erro no login Google (web):\", err);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const defaultBtnStyle = {\n    paddingVertical: 12,\n    paddingHorizontal: 16,\n    borderRadius: 8,\n    borderWidth: 1,\n    borderColor: \"#ccc\",\n    alignItems: \"center\",\n    justifyContent: \"center\",\n    backgroundColor: \"#fff\",\n  };\n\n  const defaultTxtStyle = {\n    fontWeight: \"bold\",\n  };\n\n  const customBtnStyles =\n    configs?.btnStyle && Object.keys(configs.btnStyle).length > 0\n      ? configs.btnStyle\n      : null;\n\n  const customTxtStyles =\n    configs?.txtStyle && Object.keys(configs.txtStyle).length > 0\n      ? configs.txtStyle\n      : null;\n\n  console.log(\"Comp Login WEB\", { customBtnStyles });\n\n  const defaultTxt = \"Entrar com Google\";\n  const condText = configs?.txtLabel ?? defaultTxt;\n  return (\n    <RN.Pressable\n      onPress={handleLogin}\n      disabled={loading}\n      style={({ pressed }) => [\n        customBtnStyles ?? defaultBtnStyle,\n        { opacity: pressed || loading ? 0.6 : 1 },\n      ]}\n      accessibilityRole=\"button\"\n      accessibilityLabel=\"Entrar com conta Google (Web)\"\n    >\n      <RN.Text style={[customTxtStyles ?? defaultTxtStyle]}>\n        {loading ? \"Conectando...\" : condText}\n      </RN.Text>\n    </RN.Pressable>\n  );\n};\n\n// =========================================\n// Wrapper: decide por plataforma\n// =========================================\nexport const Login = (props: TProps) => {\n  if (RN.Platform.OS === \"web\") {\n    return <LoginWeb pass={props?.pass} />;\n  }\n  return <LoginNative pass={props?.pass} />;\n};\n\nconst setUserDB = async (user: any, authFromLogin?: Auth) => {\n  console.log(\"Início SetUserDB - Parametro recebido\", user);\n\n  // Importa Firestore e salva o documento\n  const { displayName, email, photoURL, uid } = user;\n  let userToSet: Record<string, any> = {};\n\n  const userData = {\n    userName: displayName,\n    userEmail: email,\n    userImage: photoURL,\n    docId: uid,\n  };\n\n  const {\n    getFirestore,\n    collection,\n    doc,\n    setDoc,\n    updateDoc,\n    serverTimestamp,\n    getDoc,\n    getDocs,\n    query,\n    where,\n  } = await import(\"firebase/firestore\");\n\n  const fbApp = authFromLogin?.app ?? getFirebaseApp();\n  if (!fbApp) {\n    return { status: \"error\", message: \"Firebase nao inicializado.\" };\n  }\n  const db = getFirestore(fbApp);\n\n  let lotId = null;\n  let condoId = null;\n\n  // ---- LOTS\n  const lotsCol = collection(db, \"lots\");\n  const q = query(lotsCol, where(\"userEmail\", \"==\", email));\n  const searchLot = await getDocs(q);\n\n  const lotExists = searchLot.docs.length > 0;\n  if (lotExists) {\n    const lotDoc = searchLot.docs[0];\n    const lotData = lotDoc.data();\n    console.log(\"Lote encontrado para o usuario:\", lotData);\n\n    lotId = lotDoc.id;\n    condoId = lotData.condoId;\n  } else {\n    console.log(\"Nenhum lote encontrado para o usuario.\");\n  }\n\n  // ---- PREREGISTERED USERS\n  // ---- BARRAR SE ADM NÃO ADICIONOU O USUÁRIO ANTES\n  const preRegCol = collection(db, \"preRegisteredUsers\");\n  const q2 = query(preRegCol, where(\"userEmail\", \"==\", email));\n  const searchPreReg = await getDocs(q2);\n  const preRegExists = searchPreReg.docs.length > 0;\n  \n  // SE pre-registrado existe, cria/atualiza user\n  if (preRegExists) {\n    const preRegDoc = searchPreReg.docs[0];\n    const preRegData = preRegDoc.data();\n    console.log(\"Pre-registrado encontrado para o usuario:\", preRegData);\n\n    // ---- USERS\n    const usersCol = collection(db, \"users\");\n    const userDocRef = doc(usersCol, uid);\n    const userDocSnap = await getDoc(userDocRef);\n    console.log(\"Xx userDocSnap:\", \"users\", uid);\n\n    const userExists = userDocSnap.exists();\n\n    console.log(\"Xx userDocSnap:\", userExists);\n\n    if (userExists) {\n      const fullRegister = userDocSnap.data().fullRegister;\n\n      userToSet = {\n        updatedAt: serverTimestamp(),\n        ...userData,\n\n        fullRegister,\n        condoId: condoId ?? null,\n        lotId: lotId ?? null,\n      };\n\n      // Atualiza documento existente\n      await updateDoc(userDocRef, userToSet);\n      console.log(\"Usuario atualizado no banco de dados.\");\n    }\n\n    if (!userExists) {\n      userToSet = {\n        createdAt: serverTimestamp(),\n        ...userData,\n\n        typeAccount: \"app\",\n        fullRegister: false,\n        condoId: condoId ?? null,\n        lotId: lotId ?? null,\n        steps: {},\n      };\n      console.log(\"Novo usuario adicionado ao banco de dados.\");\n      await setDoc(userDocRef, userToSet);\n    }\n\n    // Fallback\n    return { status: \"success\", data: userToSet };\n  } \n  else {\n    console.log(\"Nenhum pre-registrado encontrado para o usuario.\");\n\n    return {\n      status: \"error\",\n      data: null,\n      message: \"Usuario nao pre-registrado.\",\n    };\n  }\n};"}}