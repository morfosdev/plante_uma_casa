{"1763046301616":{"actionType":"saveAll","createdAt":"1763046301616","actionID":"1763046301616","userID":"#TEMP","path":"system.capsules.3757bc92-00a4-4393-a217-cd330440d3b5.capsUseCodeInfo.capsUseInputs.sss_custom_caps-0.capsIptTxtValue","oldValue":"async () => {\n  const css1 =\n    \"color: limegreen; background-color: darkcyan; font-size: 11px; padding: 2px 6px; border-radius: 3px\";\n\n  try {\n    const { getFirestore, doc, updateDoc } = await import(\n      \"firebase/firestore\"\n    );\n    const fbInit = tools.getCtData(\"all.temp.fireInit\");\n    const db = getFirestore(fbInit);\n\n    const lotId = tools.getCtData(\"sc.A10.currents.currId1\");\n    const form = tools.getCtData(\"sc.A10.forms.editChanges\");\n    const data = tools.getCtData(\"sc.A9.currents.currLoteData\"); // ‚Üê AQUI\n\n    console.log({ lotId, form, data });\n\n    if (!lotId) {\n      console.warn(\"Nenhum lote selecionado (lotId ausente)\");\n      return;\n    }\n\n    // -------------------------\n    // Normaliza√ß√£o dos campos\n    // -------------------------\n    const rawValue = (form?.value || \"\").toString().replace(\",\", \".\").trim();\n    const date = (form?.date || \"\").trim();\n    const description = (form?.description || \"\").trim();\n    const value = parseFloat(rawValue);\n\n    if (isNaN(value) || value <= 0 || !date) {\n      console.warn(\"Valor ou data inv√°lidos:\", { value, rawValue, date });\n      return;\n    }\n\n    // -------------------------\n    // Hist√≥rico do lote\n    // -------------------------\n    const existingInstallments = data?.installments || {};\n\n    // Filtrar chaves tipo i1, i2, i3...\n    const installmentKeys = Object.keys(existingInstallments).filter((key) =>\n      /^i\\d+$/.test(key)\n    );\n\n    const nextIndex =\n      installmentKeys.length === 0\n        ? 1\n        : installmentKeys\n            .map((key) => parseInt(key.slice(1), 10))\n            .filter((n) => !isNaN(n))\n            .reduce((max, n) => Math.max(max, n), 0) + 1;\n\n    const newInstallmentId = \"i\" + nextIndex;\n\n    // -------------------------\n    // Nova parcela\n    // -------------------------\n    const newInstallment = {\n      installmentId: newInstallmentId,\n      date,\n      description,\n      value: value.toFixed(2),\n    };\n\n    // -------------------------\n    // Atualiza hist√≥rico\n    // -------------------------\n    const updatedInstallments = {\n      ...existingInstallments,\n      [newInstallmentId]: newInstallment,\n    };\n\n    // Reconta total de parcelas\n    const allKeys = Object.keys(updatedInstallments).filter((k) =>\n      /^i\\d+$/.test(k)\n    );\n    const numberOfInstallments = allKeys.length;\n\n    // Soma total\n    const totalValue = allKeys.reduce((sum, key) => {\n      const v = parseFloat(\n        (updatedInstallments[key]?.value || \"0\").toString().replace(\",\", \".\")\n      );\n      return sum + (isNaN(v) ? 0 : v);\n    }, 0);\n\n    // -------------------------\n    // Salvar no Firestore\n    // -------------------------\n    const dataToUpdate = {\n      installments: updatedInstallments,\n      numberOfInstallments,\n      totalValue: totalValue.toFixed(2),\n    };\n\n    const refDoc = doc(db, \"lots\", lotId);\n    await updateDoc(refDoc, dataToUpdate);\n\n    console.log(\"%c[OK] Parcela adicionada:\", css1, {\n      newInstallment,\n      dataToUpdate,\n    });\n\n    // -------------------------\n    // Reset da UI\n    // -------------------------\n    tools.setData({ path: \"sc.A10.forms.editChanges\", value: {} });\n    tools.setData({ path: \"all.toggles.sideRight\", value: false });\n    tools.setData({ path: \"all.toggles.a10.addFinance\", value: false });\n\n    tools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"sc.A10.feedbackMessage\"],\n        value: [\n          \"üíæ Parcela adicionada com sucesso! Total atualizado: R$ \" +\n            totalValue.toFixed(2),\n        ],\n      },\n    });\n  } catch (err) {\n    console.error(\"Erro ao salvar no Firebase:\", err);\n    tools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"sc.A10.feedbackMessage\"],\n        value: [\"‚ö†Ô∏è Erro ao salvar. Verifique o console.\"],\n      },\n    });\n  }\n};\n","newValue":"async () => {\n  const css1 =\n    \"color: limegreen; background-color: darkcyan; font-size: 11px; padding: 2px 6px; border-radius: 3px\";\n\n  try {\n    const { getFirestore, doc, updateDoc } = await import(\n      \"firebase/firestore\"\n    );\n    const fbInit = tools.getCtData(\"all.temp.fireInit\");\n    const db = getFirestore(fbInit);\n\n    const lotId = tools.getCtData(\"sc.A10.currents.currId1\");\n    const form = tools.getCtData(\"sc.A10.forms.editChanges\");\n    const data = tools.getCtData(\"sc.A9.currents.currLoteData\"); // ‚Üê AQUI\n\n    console.log({ lotId, form, data });\n\n    if (!lotId) {\n      console.warn(\"Nenhum lote selecionado (lotId ausente)\");\n      return;\n    }\n\n    // -------------------------\n    // Normaliza√ß√£o dos campos\n    // -------------------------\n    const rawValue = (form?.value || \"\").toString().replace(\",\", \".\").trim();\n    const date = (form?.date || \"\").trim();\n    const description = (form?.description || \"\").trim();\n    const value = parseFloat(rawValue);\n\n    if (isNaN(value) || value <= 0 || !date) {\n      console.warn(\"Valor ou data inv√°lidos:\", { value, rawValue, date });\n      return;\n    }\n\n    // -------------------------\n    // Hist√≥rico do lote\n    // -------------------------\n    const existingInstallments = data?.installments || {};\n\n    // Filtrar chaves tipo i1, i2, i3...\n    const installmentKeys = Object.keys(existingInstallments).filter((key) =>\n      /^i\\d+$/.test(key)\n    );\n\n    const nextIndex =\n      installmentKeys.length === 0\n        ? 1\n        : installmentKeys\n            .map((key) => parseInt(key.slice(1), 10))\n            .filter((n) => !isNaN(n))\n            .reduce((max, n) => Math.max(max, n), 0) + 1;\n\n    const newInstallmentId = \"i\" + nextIndex;\n\n    // -------------------------\n    // Nova parcela\n    // -------------------------\n    const newInstallment = {\n      installmentId: newInstallmentId,\n      date,\n      description,\n      value: value.toFixed(2),\n    };\n\n    // -------------------------\n    // Atualiza hist√≥rico\n    // -------------------------\n    const updatedInstallments = {\n      ...existingInstallments,\n      [newInstallmentId]: newInstallment,\n    };\n\n    // Reconta total de parcelas\n    const allKeys = Object.keys(updatedInstallments).filter((k) =>\n      /^i\\d+$/.test(k)\n    );\n    const numberOfInstallments = allKeys.length;\n\n    // Soma total\n    const totalValue = allKeys.reduce((sum, key) => {\n      const v = parseFloat(\n        (updatedInstallments[key]?.value || \"0\").toString().replace(\",\", \".\")\n      );\n      return sum + (isNaN(v) ? 0 : v);\n    }, 0);\n\n    // -------------------------\n    // Salvar no Firestore\n    // -------------------------\n    const dataToUpdate = {\n      installments: updatedInstallments,\n      numberOfInstallments,\n      totalValue: totalValue.toFixed(2),\n    };\n\n    const refDoc = doc(db, \"lots\", lotId);\n    await updateDoc(refDoc, dataToUpdate);\n\n    console.log(\"%c[OK] Parcela adicionada:\", css1, {\n      newInstallment,\n      dataToUpdate,\n    });\n\n    // -------------------------\n    // Reset da UI\n    // -------------------------\n    tools.setData({ path: \"sc.A10.forms.editChanges\", value: {} });\n    tools.setData({ path: \"all.toggles.sideRight\", value: false });\n    tools.setData({ path: \"all.toggles.a10.addFinance\", value: false });\n\n    tools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"sc.A10.feedbackMessage\"],\n        value: [\n          \"üíæ Parcela adicionada com sucesso! Total atualizado: R$ \" +\n            totalValue.toFixed(2),\n        ],\n      },\n    });\n  } catch (err) {\n    console.error(\"Erro ao salvar no Firebase:\", err);\n    tools.functions.setVar({\n      args: \"\",\n      pass: {\n        keyPath: [\"sc.A10.feedbackMessage\"],\n        value: [\"‚ö†Ô∏è Erro ao salvar. Verifique o console.\"],\n      },\n    });\n  }\n}"}}